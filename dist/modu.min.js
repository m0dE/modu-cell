/* Modu Engine - Built: 2026-01-09T21:55:05.677Z - Commit: e02003d */
"use strict";var moduNetwork=(()=>{var z=Object.defineProperty,we=Object.getOwnPropertyDescriptor,ye=Object.getOwnPropertyNames,pe=Object.prototype.hasOwnProperty,Se=(t,e)=>{for(var c in e)z(t,c,{get:e[c],enumerable:!0})},me=(t,e,c,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of ye(e))!pe.call(t,r)&&r!==c&&z(t,r,{get:()=>e[r],enumerable:!(n=we(e,r))||n.enumerable});return t},Ie=t=>me(z({},"__esModule",{value:!0}),t),Z={};Se(Z,{connect:()=>V,decodeBinaryMessage:()=>oe,encodeSyncHash:()=>re,getRandomRoom:()=>ae,hashClientId:()=>Y,listRooms:()=>ie,modd:()=>ce,registerClientId:()=>x,unregisterClientId:()=>ne});var q="modd_auth_token",ee="modd_auth_return_url",Te=class{constructor(){this.appId=null,this.centralServiceUrl="https://nodes.modd.io",this.debug=!1,this.initialized=!1,this.successCallbacks=[],this.errorCallbacks=[],this.stateChangeCallbacks=[],this.currentUser=null,this.pendingAuthCode=null,this.pendingAuthError=null}init(t){if(this.appId=t.appId,this.debug=t.debug||!1,t.centralServiceUrl)this.centralServiceUrl=t.centralServiceUrl;else if(typeof window<"u"){const e=window.location.hostname;(e==="localhost"||e==="127.0.0.1")&&(this.centralServiceUrl="http://localhost:9001")}this.initialized=!0,this.log("Auth module initialized",{appId:this.appId,centralServiceUrl:this.centralServiceUrl}),this.handleAuthCallback(),this.checkExistingSession()}login(t){this.ensureInitialized();const e=t?.provider,c=typeof window<"u"?window.location.href:"/";typeof localStorage<"u"&&localStorage.setItem(ee,c);const n=new URLSearchParams({appId:this.appId,returnUrl:c});let r;e?r=`${this.centralServiceUrl}/auth/${e}?${n}`:r=`${this.centralServiceUrl}/auth/select?${n}`,this.log("Starting login flow",{provider:e,authUrl:r}),typeof window<"u"&&(window.location.href=r)}async logout(){this.ensureInitialized();const t=this.getStoredToken();if(t)try{await fetch(`${this.centralServiceUrl}/auth/logout`,{method:"POST",headers:{Authorization:`Bearer ${t}`}})}catch(e){this.log("Logout API call failed (continuing anyway)",e)}this.clearStoredToken(),this.currentUser=null,this.notifyStateChange(null),this.log("User logged out")}async getUser(){if(this.ensureInitialized(),this.currentUser)return this.currentUser;const t=this.getStoredToken();if(!t)return null;try{const e=await fetch(`${this.centralServiceUrl}/auth/whoami`,{headers:{Authorization:`Bearer ${t}`}});if(!e.ok)return this.clearStoredToken(),null;const c=await e.json();return this.currentUser=c.user,this.currentUser}catch(e){return this.log("Failed to get user",e),null}}async deleteAccount(){this.ensureInitialized();const t=this.getStoredToken();if(!t)throw new Error("Not logged in");const e=await fetch(`${this.centralServiceUrl}/auth/account`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}});if(!e.ok){const c=await e.json().catch(()=>({error:"Failed to delete account"}));throw new Error(c.error)}this.clearStoredToken(),this.currentUser=null,this.notifyStateChange(null),this.log("Account deleted")}onSuccess(t){if(this.successCallbacks.push(t),this.pendingAuthCode){const e=this.pendingAuthCode;this.pendingAuthCode=null,t(e)}return()=>{const e=this.successCallbacks.indexOf(t);e!==-1&&this.successCallbacks.splice(e,1)}}onError(t){if(this.errorCallbacks.push(t),this.pendingAuthError){const e=this.pendingAuthError;this.pendingAuthError=null,t(e)}return()=>{const e=this.errorCallbacks.indexOf(t);e!==-1&&this.errorCallbacks.splice(e,1)}}onAuthStateChange(t){return this.stateChangeCallbacks.push(t),t(this.currentUser),()=>{const e=this.stateChangeCallbacks.indexOf(t);e!==-1&&this.stateChangeCallbacks.splice(e,1)}}getToken(){return this.getStoredToken()}setToken(t){typeof localStorage<"u"&&localStorage.setItem(q,t),this.checkExistingSession()}ensureInitialized(){if(!this.initialized||!this.appId)throw new Error("Auth module not initialized. Call moddNetwork.auth.init() first.")}async handleAuthCallback(){if(typeof window>"u")return;const t=new URL(window.location.href),e=t.searchParams.get("code"),c=t.searchParams.get("error"),n=t.searchParams.get("error_description");if(c){this.log("Auth error received",{error:c,errorDescription:n}),t.searchParams.delete("error"),t.searchParams.delete("error_description"),window.history.replaceState({},"",t.toString()),this.pendingAuthError={code:c,message:n||c},this.errorCallbacks.forEach(r=>r(this.pendingAuthError));return}if(e){this.log("Auth code received",{code:e.substring(0,20)+"..."}),t.searchParams.delete("code"),window.history.replaceState({},"",t.toString());try{const r=await fetch(`${this.centralServiceUrl}/auth/exchange`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:e})});if(r.ok){const{token:h}=await r.json();h&&(typeof localStorage<"u"&&localStorage.setItem(q,h),this.log("Session token stored"))}else this.log("Failed to exchange auth code for session token")}catch(r){this.log("Error exchanging auth code:",r)}this.pendingAuthCode=e,this.successCallbacks.forEach(r=>r(e))}}async checkExistingSession(){const t=await this.getUser();t?this.notifyStateChange(t):this.getStoredToken()===null&&this.currentUser!==null&&this.notifyStateChange(null)}notifyStateChange(t){this.currentUser=t,this.stateChangeCallbacks.forEach(e=>e(t))}getStoredToken(){return typeof localStorage>"u"?null:localStorage.getItem(q)}clearStoredToken(){typeof localStorage<"u"&&(localStorage.removeItem(q),localStorage.removeItem(ee))}log(...t){this.debug&&console.log("[modd-auth]",...t)}},te=new Te;typeof window<"u"&&(window.moddAuth=te);var A={TICK:1,INITIAL_STATE:2,ROOM_JOINED:3,ROOM_CREATED:4,ERROR:5,SNAPSHOT_UPDATE:6,ROOM_LEFT:7,SYNC_HASH:8,CLIENT_LIST_UPDATE:9,BINARY_INPUT:32,BINARY_SNAPSHOT:33,STATE_HASH:48,PARTITION_DATA:49};function Y(t){let e=2166136261;for(let c=0;c<t.length;c++)e^=t.charCodeAt(c),e=Math.imul(e,16777619)>>>0;return e}var K=new Map;function x(t){const e=Y(t);K.set(e,t)}function ne(t){const e=Y(t);K.delete(e)}function D(t){return K.get(t)}function Ue(t){if(t.clientHash===void 0)return!1;const e=D(t.clientHash);return e&&t.clientId!==e?(t.clientId=e,!0):!1}function re(t,e,c,n){const r=new TextEncoder().encode(t),h=new TextEncoder().encode(e),a=new Uint8Array(3+r.length+2+h.length+4+4),u=new DataView(a.buffer);let i=0;return a[i++]=A.SYNC_HASH,u.setUint16(i,r.length,!0),i+=2,a.set(r,i),i+=r.length,u.setUint16(i,h.length,!0),i+=2,a.set(h,i),i+=h.length,u.setUint32(i,c,!0),i+=4,u.setUint32(i,n,!0),a}function oe(t){if(t.byteLength===0)return null;const e=new DataView(t),c=e.getUint8(0);try{switch(c){case A.TICK:{const n=e.getUint32(1,!0);let r=[],h,a;if(t.byteLength>9){h=e.getUint32(5,!0);const u=e.getUint8(9);let i=10;if(u>0&&i+u<=t.byteLength&&(a=new TextDecoder().decode(new Uint8Array(t,i,u)),i+=u),i>=t.byteLength)return{type:"TICK",frame:n,snapshotFrame:h,snapshotHash:a,inputs:r,events:r};const _=e.getUint8(i);i++;for(let O=0;O<_&&i<t.byteLength;O++){const T=e.getUint32(i,!0);i+=4;const g=e.getUint32(i,!0);i+=4;const C=e.getUint16(i,!0);if(i+=2,i+C>t.byteLength)break;const k=new Uint8Array(t,i,C);i+=C;let o;const y=k[0];if(y===123||y===91)try{const N=new TextDecoder().decode(k);o=JSON.parse(N)}catch{o=k}else o=k;let p;typeof o=="object"&&!(o instanceof Uint8Array)?(o.clientId&&!D(T)&&x(o.clientId),p=o.clientId||D(T)||`hash_${T.toString(16)}`):p=D(T)||`hash_${T.toString(16)}`,r.push({seq:g,data:o,clientId:p,clientHash:T})}}return{type:"TICK",frame:n,snapshotFrame:h,snapshotHash:a,inputs:r,events:r}}case A.INITIAL_STATE:{let n=1;const r=e.getUint32(n,!0);n+=4;const h=e.getUint16(n,!0);if(n+=2,n+h>t.byteLength)return console.error("[modu-network] Buffer overflow reading INITIAL_STATE roomId"),null;const a=new TextDecoder().decode(new Uint8Array(t,n,h));n+=h;const u=e.getUint32(n,!0);if(n+=4,n+u>t.byteLength)return console.error("[modu-network] Buffer overflow reading INITIAL_STATE snapshot"),null;const i=new Uint8Array(t,n,u);n+=u;const _=e.getUint16(n,!0);n+=2;const O=[];for(let T=0;T<_&&n<t.byteLength;T++){const g=e.getUint32(n,!0);n+=4;const C=e.getUint32(n,!0);n+=4;const k=e.getUint32(n,!0);n+=4;const o=e.getUint16(n,!0);if(n+=2,n+o>t.byteLength)break;const y=new Uint8Array(t,n,o);n+=o;let p;const N=y[0];if(N===123||N===91)try{const $=new TextDecoder().decode(y);p=JSON.parse($)}catch{p=y}else p=y;let L;typeof p=="object"&&!(p instanceof Uint8Array)?(p.clientId&&!D(g)&&x(p.clientId),L=p.clientId||D(g)||`hash_${g.toString(16)}`):L=D(g)||`hash_${g.toString(16)}`,O.push({seq:C,frame:k,data:p,clientId:L,clientHash:g})}return{type:"INITIAL_STATE",frame:r,snapshot:i,snapshotHash:"",inputs:O,events:O}}case A.ROOM_CREATED:{let n=1;const r=e.getUint16(n,!0);n+=2;const h=new TextDecoder().decode(new Uint8Array(t,n,r));n+=r;const a=e.getUint16(n,!0);n+=2;const u=new TextDecoder().decode(new Uint8Array(t,n,a));n+=a;const i=e.getUint32(n,!0);n+=4;const _=new TextDecoder().decode(new Uint8Array(t,n,i)),{snapshot:O,snapshotHash:T}=JSON.parse(_);return{type:"ROOM_CREATED",roomId:h,clientId:u,snapshot:O,snapshotHash:T}}case A.ROOM_JOINED:{let n=1;const r=e.getUint16(n,!0);n+=2;const h=new TextDecoder().decode(new Uint8Array(t,n,r));n+=r;const a=e.getUint16(n,!0);n+=2;const u=new TextDecoder().decode(new Uint8Array(t,n,a));return{type:"ROOM_JOINED",roomId:h,clientId:u}}case A.ERROR:{const n=e.getUint16(1,!0);return{type:"ERROR",message:new TextDecoder().decode(new Uint8Array(t,3,n))}}case A.SNAPSHOT_UPDATE:{let n=1;const r=e.getUint16(n,!0);n+=2;const h=new TextDecoder().decode(new Uint8Array(t,n,r));n+=r;const a=e.getUint32(n,!0);n+=4;const u=new TextDecoder().decode(new Uint8Array(t,n,a)),{snapshot:i,snapshotHash:_}=JSON.parse(u);return{type:"SNAPSHOT_UPDATE",roomId:h,snapshot:i,snapshotHash:_}}case A.ROOM_LEFT:{const n=e.getUint16(1,!0);return{type:"ROOM_LEFT",roomId:new TextDecoder().decode(new Uint8Array(t,3,n))}}case A.CLIENT_LIST_UPDATE:{let n=1;const r=e.getUint16(n,!0);n+=2;const h=new TextDecoder().decode(new Uint8Array(t,n,r));n+=r;const a=e.getUint32(n,!0);n+=4;const u=new TextDecoder().decode(new Uint8Array(t,n,a)),i=JSON.parse(u);return{type:"CLIENT_LIST_UPDATE",roomId:h,clients:i}}case A.BINARY_SNAPSHOT:return{type:"BINARY_SNAPSHOT",binaryData:new Uint8Array(t,1)};default:return null}}catch(n){return console.error("[modu-network] Decode error:",n),null}}async function Ae(t){return t instanceof ArrayBuffer?t:typeof Blob<"u"&&t instanceof Blob?await t.arrayBuffer():new Uint8Array(t).buffer}async function V(t,e){const c=e.snapshot||{},n=e.user||null,r=e.onConnect||(()=>{}),h=e.onDisconnect||(()=>{}),a=e.onError||(v=>console.error("[modu-network]",v)),u=e.onMessage||(()=>{}),i=e.onTick||null,_=e.getStateHash||null,O=e.appId;if(!O)throw new Error("[modu-network] appId is required. Pass appId in connect options.");const T=e.centralServiceUrl||(typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")?"http://localhost:9001":"https://nodes.modd.io");console.log("[modu-network] Central service URL:",T);let g=!1,C=new Set,k=[],o=null,y=null,p=null,N=e.fps||20,L=null,$=0,U=0,le=0,de=0,he=0,ue=0,W=null,G=null,B=0,Q=0,M=0,j=null;function X(v){for(const P of v){const J=P.data||{},b=J.type||P.type;if(b==="join"||b==="reconnect"){const R=J.clientId||P.clientId;R&&x(R)}else if(b==="leave"){const R=J.clientId||P.clientId;R&&ne(R)}}}try{const v={};e.joinToken&&(v.joinToken=e.joinToken);const P=e.authToken||(typeof localStorage<"u"?localStorage.getItem("modd_auth_token"):null);if(P&&!e.joinToken&&(v.authToken=P),e.nodeUrl){const H=e.nodeUrl.match(/:(\d+)/);H&&(v.preferredNodeId=`port_${H[1]}`),console.log("[modu-network] Requesting preferred node:",e.nodeUrl)}const J=`${T}/api/apps/${O}/rooms/${t}/connect`,b=await fetch(J,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(v)});if(!b.ok){const H=await b.json().catch(()=>({error:`HTTP ${b.status}`}));throw new Error(`Failed to get node assignment: ${H.error||b.statusText}`)}const R=await b.json();y=R.url,p=R.token,N=R.fps||20;const ke=e.nodeUrl&&R.url===e.nodeUrl;console.log("[modu-network] Received Node URL:",y,"token:",p?"yes":"no","fps:",N,ke?"(preferred)":"");const Ee=typeof globalThis<"u"&&globalThis.WebSocket?globalThis.WebSocket:WebSocket;return new Promise((H,ge)=>{L=H;const Oe=p?`${y}?token=${encodeURIComponent(p)}`:y;o=new Ee(Oe),o.binaryType="arraybuffer";const fe={send(d){if(!g||!o||o.readyState!==1)return;if(d instanceof Uint8Array||d instanceof ArrayBuffer){const s=d instanceof Uint8Array?d:new Uint8Array(d),l=new Uint8Array(5+s.length),S=new DataView(l.buffer);l[0]=32,S.setUint32(1,M,!0),l.set(s,5),U+=l.length,o.send(l);return}const f=JSON.stringify({type:"SEND_INPUT",payload:{roomId:t,data:d}});U+=f.length,o.send(f)},sendSnapshot(d,f,s,l){if(!g||!o)return;if(d instanceof Uint8Array||d instanceof ArrayBuffer){const E=d instanceof Uint8Array?d:new Uint8Array(d),m=new TextEncoder().encode(f||""),w=new Uint8Array(10+m.length+E.length);w[0]=35;const I=new DataView(w.buffer);I.setUint32(1,s??0,!0),I.setUint32(5,l??0,!0),w[9]=m.length,w.set(m,10),w.set(E,10+m.length),U+=w.length,o.send(w);return}const S=JSON.stringify({type:"SEND_SNAPSHOT",payload:{roomId:t,snapshot:d,hash:f}});U+=S.length,o.send(S)},leaveRoom(){if(g&&o){const d=JSON.stringify({type:"LEAVE_ROOM",payload:{roomId:t}});U+=d.length,o.send(d)}o&&o.close()},getClients(){if(g&&o&&o.readyState===1){const d=JSON.stringify({type:"GET_CLIENTS",payload:{roomId:t}});U+=d.length,o.send(d)}},close(){o&&o.close()},get connected(){return g},get clientId(){return j},get node(){return y?y.match(/:(\d+)/)?.[1]||y:null},get bandwidthIn(){return he},get bandwidthOut(){return ue},get totalBytesIn(){return $},get totalBytesOut(){return U},get frame(){return M},getLatency(){return"0"},sendStateHash(d,f){if(!g||!o||o.readyState!==1)return;const s=new Uint8Array(9),l=new DataView(s.buffer);s[0]=A.STATE_HASH,l.setUint32(1,d,!0),l.setUint32(5,f>>>0,!0),U+=9,o.send(s)},sendPartitionData(d,f,s){if(!g||!o||o.readyState!==1)return;const l=new Uint8Array(8+s.length),S=new DataView(l.buffer);l[0]=A.PARTITION_DATA,S.setUint32(1,d,!0),l[5]=f,S.setUint16(6,s.length,!0),l.set(s,8),U+=l.length,o.send(l)}};o.onopen=()=>{W=setInterval(()=>{he=$-le,ue=U-de,le=$,de=U},1e3),_&&(G=setInterval(()=>{if(!(!g||!o||o.readyState!==1))try{const f=_();if(f){const s=re(t,f,B,Q);U+=s.byteLength,o.send(s)}}catch(f){console.warn("[modu-network] Error getting state hash:",f)}},1e3));const d=JSON.stringify({type:"JOIN_ROOM",payload:{roomId:t,user:n}});U+=d.length,o.send(d)},o.onerror=d=>{const f=`Failed to connect to ${y}: ${d.message||"Unknown error"}`;a(f),g||ge(new Error(f))},o.onclose=()=>{g=!1,W&&clearInterval(W),G&&clearInterval(G),h()},o.onmessage=async d=>{let f;try{f=await Ae(d.data)}catch(l){console.warn("[modu-network] Failed to read message data:",l);return}$+=f.byteLength;const s=oe(f);if(s)switch(s.type){case"TICK":{if(!g){k.push(s);break}M=s.frame,Q=s.frame;const l=s.inputs||s.events||[];if(l&&l.length>0){const E=Math.max(...l.map(m=>m.seq||0));E>B&&(B=E)}const S=l.filter(E=>!C.has(E.seq));S.forEach(E=>C.add(E.seq)),S.length>0&&X(S),i&&i(s.frame,S,s.snapshotFrame,s.snapshotHash);break}case"ERROR":{if(s.message==="Room not found"){const l=JSON.stringify({type:"CREATE_ROOM",payload:{roomId:t,snapshot:c,user:n}});U+=l.length,o.send(l)}else a(s.message),ge(new Error(s.message));break}case"ROOM_CREATED":{g=!0,M=0,s.clientId&&(j=s.clientId,x(s.clientId),console.log(`[modu-network] Assigned clientId: ${s.clientId}`)),r(c,[],0,y,N,j),L&&L(fe);break}case"INITIAL_STATE":{console.log("[modu-network] Received INITIAL_STATE, connecting...");const{snapshot:l,frame:S,snapshotHash:E}=s;l&&E&&(l.snapshotHash=E);const m=s.inputs||s.events||[];if(M=S,Q=S,m&&m.length>0){const w=Math.max(...m.map(I=>I.seq||0));w>B&&(B=w),m.forEach(I=>C.add(I.seq))}if(m&&m.length>0&&X(m),g=!0,r(l,m||[],S,y,N,j),k.length>0){k.sort((w,I)=>w.frame-I.frame);for(const w of k){const I=(w.inputs||w.events||[]).filter(F=>!C.has(F.seq));I.forEach(F=>C.add(F.seq)),I.length>0&&X(I);for(const F of I)Ue(F);i&&(I.length>0||w.frame>S)&&i(w.frame,I,w.snapshotFrame,w.snapshotHash)}k=[]}L&&L(fe);break}case"ROOM_JOINED":{g=!0,s.clientId&&(j=s.clientId,x(s.clientId),console.log(`[modu-network] Assigned clientId: ${s.clientId}`));break}case"SNAPSHOT_UPDATE":{e.onSnapshot&&e.onSnapshot(s.snapshot,s.snapshotHash);break}case"BINARY_SNAPSHOT":{e.onBinarySnapshot&&e.onBinarySnapshot(s.binaryData);break}case"ROOM_LEFT":{console.log(`[modu-network] Left room ${s.roomId}`);break}case"CLIENT_LIST_UPDATE":{e.onClientsUpdate&&e.onClientsUpdate(s.clients);break}}}})}catch(v){throw new Error(`Failed to get node assignment: ${v.message}`)}}function se(t){return t||(typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")?"http://localhost:9001":"https://nodes.modd.io")}async function ie(t,e={}){const c=se(e.centralServiceUrl),n=e.limit||50,r=e.offset||0,h=`${c}/api/apps/${encodeURIComponent(t)}/rooms/list?limit=${n}&offset=${r}`,a=await fetch(h);if(!a.ok){const u=await a.json().catch(()=>({error:"Unknown error"}));throw new Error(u.error||`Failed to list rooms: ${a.statusText}`)}return await a.json()}async function ae(t,e={}){const c=se(e.centralServiceUrl),n=e.minClients??0,r=e.maxClients??999,h=`${c}/api/apps/${encodeURIComponent(t)}/rooms/random?minClients=${n}&maxClients=${r}`,a=await fetch(h);if(a.status===404)return null;if(!a.ok){const u=await a.json().catch(()=>({error:"Unknown error"}));throw new Error(u.error||`Failed to get random room: ${a.statusText}`)}return await a.json()}var ce=V;return typeof window<"u"&&(window.moddNetwork={connect:V,modd:ce,listRooms:ie,getRandomRoom:ae,auth:te}),Ie(Z)})();
"use strict";var Modu=(()=>{var bn=Object.defineProperty;var Co=Object.getOwnPropertyDescriptor;var Eo=Object.getOwnPropertyNames;var Do=Object.prototype.hasOwnProperty;var Dt=(n,e)=>{for(var t in e)bn(n,t,{get:e[t],enumerable:!0})},To=(n,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Eo(e))!Do.call(n,o)&&o!==t&&bn(n,o,{get:()=>e[o],enumerable:!(i=Co(e,o))||i.enumerable});return n};var Io=n=>To(bn({},"__esModule",{value:!0}),n);var br={};Dt(br,{AutoRenderer:()=>ft,BODY_DYNAMIC:()=>xi,BODY_KINEMATIC:()=>at,BODY_STATIC:()=>st,Body2D:()=>K,Camera2D:()=>ee,CameraSystem:()=>Gt,Entity:()=>ct,EntityBuilder:()=>dt,EntityIdAllocator:()=>ze,EntityPool:()=>Ye,FP_2PI:()=>Wn,FP_HALF:()=>ne,FP_HALF_PI:()=>$n,FP_ONE:()=>S,FP_PI:()=>Xn,FP_SHIFT:()=>qn,Game:()=>mt,INDEX_MASK:()=>I,InputPlugin:()=>$t,MAX_ENTITIES:()=>J,Physics2DSystem:()=>vt,Player:()=>ae,Prefab:()=>ht,QueryEngine:()=>Ue,QueryIterator:()=>re,RollbackBuffer:()=>zt,SHAPE_CIRCLE:()=>Oe,SHAPE_RECT:()=>Lt,SPRITE_IMAGE:()=>kt,SYSTEM_PHASES:()=>it,Simple2DRenderer:()=>ft,SparseSnapshotCodec:()=>Re,Sprite:()=>rt,SystemScheduler:()=>He,Transform2D:()=>W,World:()=>qe,applyDelta:()=>Ei,assemblePartitions:()=>Ci,codec:()=>In,computeDegradationTier:()=>wi,computePartitionAssignment:()=>Xt,computePartitionCount:()=>pt,computePartitionSeed:()=>Bn,computeSnapshotHash:()=>Ut,computeStateDelta:()=>Ht,createGame:()=>Bi,createPhysics2DSystem:()=>Ji,dRandom:()=>gi,dSqrt:()=>Zn,defineComponent:()=>se,deserializeDelta:()=>bi,deserializePartition:()=>Fi,disableDeterminismGuard:()=>Ri,enableDebugUI:()=>Vi,enableDeterminismGuard:()=>Jt,fpAbs:()=>F,fpAtan2:()=>Qn,fpCeil:()=>Kn,fpClamp:()=>ke,fpCos:()=>De,fpDiv:()=>b,fpFloor:()=>jn,fpMax:()=>le,fpMin:()=>oe,fpMul:()=>p,fpSign:()=>Gn,fpSin:()=>fe,fpSqrt:()=>M,getClientPartitions:()=>Wt,getDeltaSize:()=>Ti,getEntityPartition:()=>ut,getPartition:()=>qt,isClientAssigned:()=>Ii,isDeltaEmpty:()=>Di,loadRandomState:()=>he,physics2d:()=>Ln,physics3d:()=>On,quatClone:()=>yi,quatConjugate:()=>Vt,quatFromAxisAngle:()=>Pt,quatFromEulerY:()=>fi,quatIdentity:()=>nt,quatMul:()=>Mt,quatNormalize:()=>_t,quatRotateVec3:()=>G,saveRandomState:()=>pe,serializeDelta:()=>vi,toFixed:()=>g,toFloat:()=>w,vec2:()=>Jn,vec2Add:()=>ni,vec2Clone:()=>ti,vec2Cross:()=>si,vec2Distance:()=>li,vec2DistanceSq:()=>di,vec2Dot:()=>ri,vec2FromFixed:()=>ei,vec2Length:()=>Bt,vec2LengthSq:()=>wt,vec2Lerp:()=>ci,vec2Neg:()=>oi,vec2Normalize:()=>ai,vec2Scale:()=>ii,vec2Sub:()=>It,vec2Zero:()=>Fn,vec3:()=>P,vec3Add:()=>N,vec3Clone:()=>Rt,vec3Cross:()=>j,vec3Distance:()=>hi,vec3DistanceSq:()=>mi,vec3Dot:()=>k,vec3FromFloats:()=>Te,vec3Length:()=>At,vec3LengthSq:()=>$,vec3Lerp:()=>pi,vec3Neg:()=>ye,vec3Normalize:()=>ue,vec3Scale:()=>B,vec3Sub:()=>_,vec3ToFloats:()=>ui,vec3Zero:()=>de,weightedRandomPick:()=>Rn,xxhash32:()=>En,xxhash32Combine:()=>Z,xxhash32String:()=>Si});var qn=16,S=65536,ne=32768,Xn=205887,Wn=411775,$n=102944;function g(n){return Math.round(n*65536)}function w(n){return n/65536}function p(n,e){return Number(BigInt(n)*BigInt(e)>>BigInt(16))}function b(n,e){return e===0?n>=0?2147483647:-2147483647:Number((BigInt(n)<<BigInt(16))/BigInt(e))}function F(n){return n<0?-n:n}function Gn(n){return n>0?65536:n<0?-65536:0}function oe(n,e){return n<e?n:e}function le(n,e){return n>e?n:e}function ke(n,e,t){return n<e?e:n>t?t:n}function jn(n){return n&-65536}function Kn(n){return n+65536-1&-65536}function M(n){if(n<=0)return 0;let e=BigInt(n)*BigInt(65536);if(e<=0n)return 0;let t=0n,i=e;for(;i>0n;)t++,i>>=1n;let o=1n<<(t>>1n);o===0n&&(o=1n);let r=0n;for(let s=0;s<30;s++){let a=o+e/o>>1n;if(a===o||a===r)break;r=o,o=a}for(;o*o>e;)o--;for(;(o+1n)*(o+1n)<=e;)o++;return Number(o)}function Zn(n){return w(M(g(n)))}var Tt=256,Hn=[0,402,804,1206,1608,2010,2412,2814,3216,3617,4019,4420,4821,5222,5623,6023,6424,6824,7224,7623,8022,8421,8820,9218,9616,10014,10411,10808,11204,11600,11996,12391,12785,13180,13573,13966,14359,14751,15143,15534,15924,16314,16703,17091,17479,17867,18253,18639,19024,19409,19792,20175,20557,20939,21320,21699,22078,22457,22834,23210,23586,23961,24335,24708,25080,25451,25821,26190,26558,26925,27291,27656,28020,28383,28745,29106,29466,29824,30182,30538,30893,31248,31600,31952,32303,32652,33e3,33347,33692,34037,34380,34721,35062,35401,35738,36075,36410,36744,37076,37407,37736,38064,38391,38716,39040,39362,39683,40002,40320,40636,40951,41264,41576,41886,42194,42501,42806,43110,43412,43713,44011,44308,44604,44898,45190,45480,45769,46056,46341,46624,46906,47186,47464,47741,48015,48288,48559,48828,49095,49361,49624,49886,50146,50404,50660,50914,51166,51417,51665,51911,52156,52398,52639,52878,53114,53349,53581,53812,54040,54267,54491,54714,54934,55152,55368,55582,55794,56004,56212,56418,56621,56823,57022,57219,57414,57607,57798,57986,58172,58356,58538,58718,58896,59071,59244,59415,59583,59750,59914,60075,60235,60392,60547,60700,60851,60999,61145,61288,61429,61568,61705,61839,61971,62101,62228,62353,62476,62596,62714,62830,62943,63054,63162,63268,63372,63473,63572,63668,63763,63854,63944,64031,64115,64197,64277,64354,64429,64501,64571,64639,64704,64766,64827,64884,64940,64993,65043,65091,65137,65180,65220,65259,65294,65328,65358,65387,65413,65436,65457,65476,65492,65505,65516,65525,65531,65535,65536],wo=10680707;function fe(n){if(n<0){let u=(-n/411775|0)+1;n+=u*411775}n>=411775&&(n=n%411775);let e=0;n>=205887&&(n-=205887,e=2),n>=102944&&(n=205887-n,e+=1);let t=p(n,wo),i=t>>16,o=t&65535,r=i<0?0:i>Tt?Tt:i,s=i+1,a=s<0?0:s>Tt?Tt:s,c=Hn[r]??0,l=Hn[a]??65536,d=c+p(l-c,o);return e>=2&&(d=-d),d}function De(n){return fe(n+102944)}function Qn(n,e){if(e===0&&n===0)return 0;let t=F(e),i=F(n),o;if(t>=i){let r=b(i,t);o=p(r,51472)}else{let r=b(t,i);o=102944-p(r,51472)}return e<0&&(o=205887-o),n<0&&(o=-o),o}function Jn(n,e){return{x:g(n),y:g(e)}}function Fn(){return{x:0,y:0}}function ei(n,e){return{x:n,y:e}}function ti(n){return{x:n.x,y:n.y}}function ni(n,e){return{x:n.x+e.x,y:n.y+e.y}}function It(n,e){return{x:n.x-e.x,y:n.y-e.y}}function ii(n,e){return{x:p(n.x,e),y:p(n.y,e)}}function oi(n){return{x:-n.x,y:-n.y}}function ri(n,e){return p(n.x,e.x)+p(n.y,e.y)}function si(n,e){return p(n.x,e.y)-p(n.y,e.x)}function wt(n){return p(n.x,n.x)+p(n.y,n.y)}function Bt(n){return M(wt(n))}function ai(n){let e=Bt(n);return e===0?Fn():{x:b(n.x,e),y:b(n.y,e)}}function ci(n,e,t){let i=65536-t;return{x:p(n.x,i)+p(e.x,t),y:p(n.y,i)+p(e.y,t)}}function li(n,e){return Bt(It(e,n))}function di(n,e){return wt(It(e,n))}function P(n,e,t){return{x:n,y:e,z:t}}function de(){return{x:0,y:0,z:0}}function Te(n,e,t){return{x:g(n),y:g(e),z:g(t)}}function ui(n){return{x:w(n.x),y:w(n.y),z:w(n.z)}}function Rt(n){return{x:n.x,y:n.y,z:n.z}}function N(n,e){return{x:n.x+e.x,y:n.y+e.y,z:n.z+e.z}}function _(n,e){return{x:n.x-e.x,y:n.y-e.y,z:n.z-e.z}}function B(n,e){return{x:p(n.x,e),y:p(n.y,e),z:p(n.z,e)}}function ye(n){return{x:-n.x,y:-n.y,z:-n.z}}function k(n,e){return p(n.x,e.x)+p(n.y,e.y)+p(n.z,e.z)}function j(n,e){return{x:p(n.y,e.z)-p(n.z,e.y),y:p(n.z,e.x)-p(n.x,e.z),z:p(n.x,e.y)-p(n.y,e.x)}}function $(n){return p(n.x,n.x)+p(n.y,n.y)+p(n.z,n.z)}function At(n){return M($(n))}function ue(n){let e=At(n);return e===0?de():{x:b(n.x,e),y:b(n.y,e),z:b(n.z,e)}}function pi(n,e,t){let i=65536-t;return{x:p(n.x,i)+p(e.x,t),y:p(n.y,i)+p(e.y,t),z:p(n.z,i)+p(e.z,t)}}function hi(n,e){return At(_(e,n))}function mi(n,e){return $(_(e,n))}function nt(){return{x:0,y:0,z:0,w:65536}}function Pt(n,e){let t=e>>1,i=fe(t),o=De(t),r=ue(n);return{x:p(r.x,i),y:p(r.y,i),z:p(r.z,i),w:o}}function fi(n){let e=n>>1;return{x:0,y:fe(e),z:0,w:De(e)}}function Mt(n,e){return{x:p(n.w,e.x)+p(n.x,e.w)+p(n.y,e.z)-p(n.z,e.y),y:p(n.w,e.y)-p(n.x,e.z)+p(n.y,e.w)+p(n.z,e.x),z:p(n.w,e.z)+p(n.x,e.y)-p(n.y,e.x)+p(n.z,e.w),w:p(n.w,e.w)-p(n.x,e.x)-p(n.y,e.y)-p(n.z,e.z)}}function G(n,e){let t=P(n.x,n.y,n.z),i=j(t,e),o=j(t,i);return N(e,N(B(i,n.w<<1),B(o,131072)))}function _t(n){let e=p(n.x,n.x)+p(n.y,n.y)+p(n.z,n.z)+p(n.w,n.w),t=M(e);return t===0?nt():{x:b(n.x,t),y:b(n.y,t),z:b(n.z,t),w:b(n.w,t)}}function Vt(n){return{x:-n.x,y:-n.y,z:-n.z,w:n.w}}function yi(n){return{x:n.x,y:n.y,z:n.z,w:n.w}}var ge=1,Ie=2;function Bo(){let n=ge,e=Ie;return ge=e,n^=n<<23>>>0,n^=n>>>17,n^=e,n^=e>>>26,Ie=n>>>0,ge+Ie>>>0}function Ro(n){n=n>>>0,n===0&&(n=1);let e=n;e=(e>>>16^e)*73244475>>>0,e=(e>>>16^e)*73244475>>>0,ge=(e>>>16^e)>>>0,e=n*2654435769>>>0,e=(e>>>16^e)*73244475>>>0,e=(e>>>16^e)*73244475>>>0,Ie=(e>>>16^e)>>>0,ge===0&&Ie===0&&(ge=1)}function gi(){return Bo()/4294967296}function pe(){return{s0:ge,s1:Ie}}function he(n){ge=n.s0,Ie=n.s1}Ro(1);var J=1e4;var I=1048575;var it=["input","update","prePhysics","physics","postPhysics","render"];function Ao(n){if(typeof n=="object"&&n!==null&&"type"in n){let e=n;return e.type==="f32"&&console.warn("Component field uses f32 which is NON-DETERMINISTIC. Only use for render-only data, never for synced state."),{type:e.type,default:e.default??(e.type==="bool"?!1:0)}}if(typeof n=="boolean")return{type:"bool",default:n};if(typeof n=="number")return{type:"i32",default:n};if(n==null)return{type:"i32",default:0};throw new Error(`Unsupported field type: ${typeof n}. Components can only contain numbers and booleans. Use game.internString() for string values.`)}function Po(n){switch(n){case"i32":return new Int32Array(1e4);case"u8":case"bool":return new Uint8Array(1e4);case"f32":return new Float32Array(1e4);default:throw new Error(`Unknown field type: ${n}`)}}function Mo(n){let e={};for(let[t,i]of Object.entries(n))e[t]=Po(i.type);return{mask:new Uint32Array(Math.ceil(1e4/32)),fields:e,schema:n}}function _o(n,e,t){let i=function(o){this._index=o};i.prototype={};for(let[o,r]of Object.entries(e)){let s=t.fields[o],a=r.type==="i32",c=r.type==="bool";Object.defineProperty(i.prototype,o,{get:function(){let l=s[this._index];return c?l!==0:a?w(l):l},set:function(l){c?s[this._index]=l?1:0:a?s[this._index]=g(l):s[this._index]=l},enumerable:!0,configurable:!1})}return Object.defineProperty(i.prototype,"_index",{value:0,writable:!0,enumerable:!1,configurable:!1}),i}var Cn=new Map;function se(n,e,t){if(Cn.has(n))throw new Error(`Component '${n}' is already defined`);let i={};for(let[a,c]of Object.entries(e))i[a]=Ao(c);let o=Mo(i),r=_o(n,i,o),s={name:n,schema:i,storage:o,AccessorClass:r,fieldNames:Object.keys(i),sync:t?.sync!==!1};return Cn.set(n,s),s}function xe(n,e){let t=e>>>5,i=1<<(e&31);return(n.mask[t]&i)!==0}function we(n,e){let t=e>>>5,i=1<<(e&31);n.mask[t]|=i}function Le(n,e){let t=e>>>5,i=1<<(e&31);n.mask[t]&=~i}function ot(n,e){for(let[t,i]of Object.entries(n.schema)){let o=n.fields[t];i.type==="i32"?o[e]=g(i.default):i.type==="bool"?o[e]=i.default?1:0:o[e]=i.default}}function Be(){return Cn}var ze=class{constructor(){this.freeList=[];this.nextIndex=0;this.generations=new Uint16Array(1e4)}allocate(){let e;if(this.freeList.length>0)e=this.freeList.shift();else{if(this.nextIndex>=1e4)throw new Error(`Entity limit exceeded (MAX_ENTITIES=${1e4}). Consider destroying unused entities or increasing the limit.`);e=this.nextIndex++}return this.generations[e]<<20|e}free(e){let t=e&1048575;this.generations[t]=this.generations[t]+1&4095;let i=this.findInsertIndex(t);this.freeList.splice(i,0,t)}isValid(e){let t=e&1048575,i=e>>>20;return t<this.nextIndex&&this.generations[t]===i}getIndex(e){return e&1048575}getGeneration(e){return e>>>20}getState(){return{nextIndex:this.nextIndex,freeList:[...this.freeList],generations:Array.from(this.generations.slice(0,this.nextIndex))}}setState(e){this.nextIndex=e.nextIndex,this.freeList=[...e.freeList];for(let t=0;t<e.generations.length;t++)this.generations[t]=e.generations[t]}reset(){this.nextIndex=0,this.freeList=[],this.generations.fill(0)}getActiveCount(){return this.nextIndex-this.freeList.length}getNextId(){return this.nextIndex}setNextId(e){this.nextIndex=e}allocateSpecific(e){let t=e&1048575,i=e>>>20;t>=this.nextIndex&&(this.nextIndex=t+1);let o=this.freeList.indexOf(t);return o!==-1&&this.freeList.splice(o,1),this.generations[t]=i,e}findInsertIndex(e){let t=0,i=this.freeList.length;for(;t<i;){let o=t+i>>>1;this.freeList[o]<e?t=o+1:i=o}return t}};var W=se("Transform2D",{x:0,y:0,angle:0}),K=se("Body2D",{vx:0,vy:0,angularVelocity:0,forceX:0,forceY:0,impulseX:0,impulseY:0,width:0,height:0,radius:0,mass:1,restitution:0,friction:0,bodyType:0,shapeType:1,damping:0,isSensor:!1}),ae=se("Player",{clientId:0}),rt=se("Sprite",{shape:1,width:0,height:0,radius:10,color:0,spriteId:0,offsetX:0,offsetY:0,scaleX:1,scaleY:1,layer:0,visible:!0}),kt=2,ee=se("Camera2D",{x:0,y:0,zoom:1,targetZoom:1,smoothing:.1,followEntity:0,viewportWidth:0,viewportHeight:0},{sync:!1}),xi=0,st=1,at=2,Lt=0,Oe=1;var ct=class{constructor(){this.eid=-1;this.type="";this.destroyed=!1;this.render={prevX:0,prevY:0,interpX:0,interpY:0,screenX:0,screenY:0,visible:!0};this._components=[];this._accessors=new Map;this._world=null;this._inputData=null}get(e){let t=this.eid&1048575;if(!xe(e.storage,t))throw new Error(`Entity ${this.eid} (type: ${this.type}) does not have component '${e.name}'`);let i=this._accessors.get(e);return i?i._index=t:(i=new e.AccessorClass(t),this._accessors.set(e,i)),i}has(e){return xe(e.storage,this.eid&1048575)}addComponent(e,t){let i=this.eid&1048575;if(xe(e.storage,i))throw new Error(`Entity ${this.eid} already has component '${e.name}'`);we(e.storage,i),ot(e.storage,i),this._components.push(e),this._world&&this._world.queryEngine.addComponent(this.eid,e);let o=this.get(e);if(t)for(let[r,s]of Object.entries(t))o[r]=s;return o}removeComponent(e){let t=this.eid&1048575;if(!xe(e.storage,t))throw new Error(`Entity ${this.eid} does not have component '${e.name}'`);Le(e.storage,t);let i=this._components.indexOf(e);i!==-1&&this._components.splice(i,1),this._world&&this._world.queryEngine.removeComponent(this.eid,e),this._accessors.delete(e)}destroy(){this.destroyed||(this.destroyed=!0,this._world&&this._world.destroyEntity(this))}getComponents(){return[...this._components]}get input(){return this._inputData}_setInputData(e){this._inputData=e}_savePreviousState(){for(let e of this._components){let t=this.eid&1048575;if("x"in e.storage.fields&&"y"in e.storage.fields){let i=e.storage.fields.x,o=e.storage.fields.y;this.render.prevX=w(i[t]),this.render.prevY=w(o[t]);return}}}interpolate(e){for(let t of this._components){let i=this.eid&1048575;if("x"in t.storage.fields&&"y"in t.storage.fields){let o=w(t.storage.fields.x[i]),r=w(t.storage.fields.y[i]);this.render.interpX=this.render.prevX+(o-this.render.prevX)*e,this.render.interpY=this.render.prevY+(r-this.render.prevY)*e;return}}}_init(e,t,i,o){this.eid=e,this.type=t,this.destroyed=!1,this._components=i,this._world=o,this._accessors.clear(),this.render.prevX=0,this.render.prevY=0,this.render.interpX=0,this.render.interpY=0,this.render.screenX=0,this.render.screenY=0,this.render.visible=!0,this._inputData=null}_cleanup(){this._world=null,this._components=[],this._accessors.clear(),this._inputData=null}moveTowards(e,t){if(!this.has(W)||!this.has(K))return;let i=this.get(W),o=this.get(K),r=g(e.x)-g(i.x),s=g(e.y)-g(i.y),a=p(r,r)+p(s,s);if(a===0){o.vx=0,o.vy=0;return}let c=M(a),l=g(t*60);o.vx=w(b(p(r,l),c)),o.vy=w(b(p(s,l),c))}stop(){if(!this.has(K))return;let e=this.get(K);e.vx=0,e.vy=0}setVelocity(e,t){if(!this.has(K))return;let i=this.get(K);i.vx=e,i.vy=t}distanceTo(e){if(!this.has(W))return 0;let t=this.get(W),i=g(e.x)-g(t.x),o=g(e.y)-g(t.y),r=p(i,i)+p(o,o);return w(M(r))}isWithin(e,t){if(!this.has(W))return!1;let i=this.get(W),o=g(e.x)-g(i.x),r=g(e.y)-g(i.y),s=p(o,o)+p(r,r),a=g(t),c=p(a,a);return s<=c}},Ye=class{constructor(){this.pool=[];this.active=new Map}acquire(e){let t=this.active.get(e);return t||(t=this.pool.pop()||new ct,this.active.set(e,t),t)}release(e){let t=this.active.get(e);t&&(t._cleanup(),this.active.delete(e),this.pool.push(t))}get(e){return this.active.get(e)}has(e){return this.active.has(e)}clear(){for(let e of this.active.values())e._cleanup(),this.pool.push(e);this.active.clear()}get size(){return this.active.size}};var re=class{constructor(e,t,i){this.index=0;this.eids=e.slice(),this.getEntity=t,this.isDestroyed=i}[Symbol.iterator](){return this.index=0,{next:()=>{for(;this.index<this.eids.length;){let e=this.eids[this.index++];if(this.isDestroyed(e))continue;let t=this.getEntity(e);if(t)return{done:!1,value:t}}return{done:!0,value:void 0}}}}toArray(){let e=[];for(let t of this)e.push(t);return e}first(){for(let e of this)return e;return null}find(e){for(let t of this)if(e(t))return t;return null}count(){let e=0;for(let t of this)e++;return e}},Ue=class{constructor(e,t){this.typeIndex=new Map;this.componentIndex=new Map;this.clientIdIndex=new Map;this.getEntity=e,this.isDestroyed=t}addEntity(e,t,i,o){let r=this.typeIndex.get(t);r||(r=new Set,this.typeIndex.set(t,r)),r.add(e);for(let s of i){let a=this.componentIndex.get(s);a||(a=new Set,this.componentIndex.set(s,a)),a.add(e)}o!==void 0&&this.clientIdIndex.set(o,e)}removeEntity(e,t,i,o){this.typeIndex.get(t)?.delete(e);for(let r of i)this.componentIndex.get(r)?.delete(e);o!==void 0&&this.clientIdIndex.get(o)===e&&this.clientIdIndex.delete(o)}addComponent(e,t){let i=this.componentIndex.get(t);i||(i=new Set,this.componentIndex.set(t,i)),i.add(e)}removeComponent(e,t){this.componentIndex.get(t)?.delete(e)}setClientId(e,t){this.clientIdIndex.set(t,e)}removeClientId(e){this.clientIdIndex.delete(e)}byType(e){let t=this.typeIndex.get(e),i=t?this.sortedEids(t):[];return new re(i,this.getEntity,this.isDestroyed)}byComponents(...e){if(e.length===0)return new re([],this.getEntity,this.isDestroyed);let t,i=1/0;for(let r of e){let s=this.componentIndex.get(r);if(!s||s.size===0)return new re([],this.getEntity,this.isDestroyed);s.size<i&&(i=s.size,t=s)}if(!t)return new re([],this.getEntity,this.isDestroyed);let o=[];for(let r of t){let s=!0;for(let a of e)if(a.storage&&!xe(a.storage,r&1048575)){s=!1;break}s&&o.push(r)}return o.sort((r,s)=>r-s),new re(o,this.getEntity,this.isDestroyed)}query(e,...t){if(typeof e=="string"){if(t.length>0){let i=this.typeIndex.get(e);if(!i||i.size===0)return new re([],this.getEntity,this.isDestroyed);let o=[];for(let r of i){let s=!0;for(let a of t)if(a.storage&&!xe(a.storage,r&1048575)){s=!1;break}s&&o.push(r)}return o.sort((r,s)=>r-s),new re(o,this.getEntity,this.isDestroyed)}return this.byType(e)}return this.byComponents(e,...t)}getByClientId(e){return this.clientIdIndex.get(e)}getAllEids(){let e=new Set;for(let t of this.typeIndex.values())for(let i of t)e.add(i);return Array.from(e).sort((t,i)=>t-i)}clear(){this.typeIndex.clear(),this.componentIndex.clear(),this.clientIdIndex.clear()}sortedEids(e){return Array.from(e).sort((t,i)=>t-i)}};var He=class{constructor(){this.systems=new Map;this.isClient=!0;this.nextSystemId=0;for(let e of it)this.systems.set(e,[])}setIsClient(e){this.isClient=e}add(e,t={}){let i=t.phase||"update",o=this.systems.get(i);if(!o)throw new Error(`Unknown system phase: ${i}`);let r={fn:e,options:t,order:t.order??this.nextSystemId++};return o.push(r),o.sort((s,a)=>s.order-a.order),()=>this.remove(e)}remove(e){for(let t of this.systems.values()){let i=t.findIndex(o=>o.fn===e);if(i!==-1)return t.splice(i,1),!0}return!1}runPhase(e){let t=this.systems.get(e);if(t){for(let i of t)if(!(i.options.client&&!this.isClient)&&!(i.options.server&&this.isClient))try{let o=i.fn();if(o&&typeof o=="object"&&"then"in o)throw new Error("System returned a Promise. Async systems are not allowed as they break determinism. Remove 'await' from your system.")}catch(o){throw console.error(`Error in system during '${e}' phase:`,o),o}}}runAll(){for(let e of it)e==="render"&&!this.isClient||this.runPhase(e)}getSystemCounts(){let e={};for(let[t,i]of this.systems)e[t]=i.length;return e}clear(){for(let e of this.systems.values())e.length=0;this.nextSystemId=0}};var Re=class{encode(e,t,i,o,r,s,a=0,c=0,l){let d=new Uint32Array(Math.ceil(1e4/32)),u=[],h=[...e].sort((y,x)=>y-x);for(let y of h){let x=y&1048575;d[x>>>5]|=1<<(x&31),u.push({eid:y,type:t(y),clientId:i(y)})}let m=new Map,f=Be();for(let[y,x]of f){if(!x.sync||x.fieldNames.length===0)continue;let C=0;for(let D of x.fieldNames){let R=x.storage.fields[D];C+=h.length*R.BYTES_PER_ELEMENT}let E=new ArrayBuffer(C),A=0;for(let D of x.fieldNames){let R=x.storage.fields[D],O=R.BYTES_PER_ELEMENT,L=new R.constructor(E,A,h.length);for(let q=0;q<h.length;q++){let X=h[q]&1048575;L[q]=R[X]}A+=h.length*O}m.set(y,E)}return{frame:a,seq:c,entityMask:d,entityMeta:u,componentData:m,entityCount:h.length,allocator:r,strings:s,rng:l}}decode(e,t,i,o,r,s){t(),i(e.allocator),o(e.strings),e.rng&&s&&s(e.rng);let a=Be();for(let c=0;c<e.entityMeta.length;c++){let l=e.entityMeta[c];r(l.eid,l.type,l.clientId)}for(let[c,l]of e.componentData){let d=a.get(c);if(!d)continue;let u=0;for(let h of d.fieldNames){let m=d.storage.fields[h],f=m.BYTES_PER_ELEMENT,y=new m.constructor(l,u,e.entityCount);for(let x=0;x<e.entityMeta.length;x++){let v=e.entityMeta[x].eid&1048575;m[v]=y[x]}u+=e.entityCount*f}}}getSize(e){let t=0;t+=e.entityMask.byteLength,t+=e.entityMeta.length*32;for(let i of e.componentData.values())t+=i.byteLength;return t+=e.allocator.freeList.length*4,t+=e.allocator.generations.length*2,t}toBinary(e){let t=JSON.stringify({frame:e.frame,seq:e.seq,entityMeta:e.entityMeta,allocator:e.allocator,strings:e.strings,rng:e.rng,componentNames:Array.from(e.componentData.keys())}),i=new TextEncoder().encode(t),o=i.length,r=0,s=[];for(let u of e.componentData.values())s.push(u.byteLength),r+=u.byteLength;let a=4+o+4+e.entityMask.byteLength+r,c=new ArrayBuffer(a),l=new DataView(c),d=0;l.setUint32(d,o,!0),d+=4,new Uint8Array(c,d,o).set(i),d+=o,l.setUint32(d,e.entityMask.byteLength,!0),d+=4,new Uint8Array(c,d,e.entityMask.byteLength).set(new Uint8Array(e.entityMask.buffer)),d+=e.entityMask.byteLength;for(let u of e.componentData.values())new Uint8Array(c,d,u.byteLength).set(new Uint8Array(u)),d+=u.byteLength;return c}fromBinary(e){let t=new DataView(e),i=0,o=t.getUint32(i,!0);i+=4;let r=new Uint8Array(e,i,o),s=new TextDecoder().decode(r),a=JSON.parse(s);i+=o;let c=t.getUint32(i,!0);i+=4;let l=new Uint32Array(e.slice(i,i+c));i+=c;let d=new Map,u=Be();for(let h of a.componentNames){let m=u.get(h);if(!m)continue;let f=0;for(let x of m.fieldNames){let v=m.storage.fields[x];f+=a.entityMeta.length*v.BYTES_PER_ELEMENT}let y=e.slice(i,i+f);d.set(h,y),i+=f}return{frame:a.frame,seq:a.seq,entityMask:l,entityMeta:a.entityMeta,componentData:d,entityCount:a.entityMeta.length,allocator:a.allocator,strings:a.strings,rng:a.rng}}},zt=class{constructor(e=60){this.maxFrames=e;this.snapshots=new Map;this.codec=new Re}save(e,t){this.snapshots.set(e,t);let i=e-this.maxFrames+1;for(let o of this.snapshots.keys())o<i&&this.snapshots.delete(o)}get(e){return this.snapshots.get(e)}has(e){return this.snapshots.has(e)}getOldestFrame(){let e;for(let t of this.snapshots.keys())(e===void 0||t<e)&&(e=t);return e}getNewestFrame(){let e;for(let t of this.snapshots.keys())(e===void 0||t>e)&&(e=t);return e}clear(){this.snapshots.clear()}get size(){return this.snapshots.size}};var Ot=class{constructor(){this.stringToId=new Map;this.idToString=new Map;this.nextId=new Map}intern(e,t){let i=this.stringToId.get(e);i||(i=new Map,this.stringToId.set(e,i));let o=i.get(t);if(o!==void 0)return o;let r=this.nextId.get(e)??1;this.nextId.set(e,r+1),i.set(t,r);let s=this.idToString.get(e);return s||(s=new Map,this.idToString.set(e,s)),s.set(r,t),r}getString(e,t){return this.idToString.get(e)?.get(t)??null}getState(){let e={},t={};for(let[i,o]of this.stringToId)e[i]=Object.fromEntries(o),t[i]=this.nextId.get(i)??1;return{tables:e,nextIds:t}}setState(e){this.stringToId.clear(),this.idToString.clear(),this.nextId.clear();for(let[t,i]of Object.entries(e.tables)){let o=new Map(Object.entries(i));this.stringToId.set(t,o);let r=new Map;for(let[s,a]of o)r.set(a,s);this.idToString.set(t,r),this.nextId.set(t,e.nextIds[t]??1)}}clear(){this.stringToId.clear(),this.idToString.clear(),this.nextId.clear()}};function me(n,e){return(n>>>0)+(e>>>0)>>>0}function ie(n,e){let t=n&65535,i=n>>>16,o=e&65535,r=e>>>16,s=t*o,a=t*r,c=i*o;return s+(a+c<<16)>>>0}function Se(n,e){return(n<<e|n>>>32-e)>>>0}function lt(n,e){return(n[e]|n[e+1]<<8|n[e+2]<<16|n[e+3]<<24)>>>0}function Yt(n,e){return n=me(n,ie(e,2246822519)),n=Se(n,13),n=ie(n,2654435761),n}function En(n,e=0){e=e>>>0;let t=n.length,i,o=0;if(t>=16){let r=me(me(e,2654435761),2246822519),s=me(e,2246822519),a=e,c=e-2654435761>>>0,l=t-16;do r=Yt(r,lt(n,o)),o+=4,s=Yt(s,lt(n,o)),o+=4,a=Yt(a,lt(n,o)),o+=4,c=Yt(c,lt(n,o)),o+=4;while(o<=l);i=Se(r,1)+Se(s,7)+Se(a,12)+Se(c,18),i=i>>>0}else i=me(e,374761393);for(i=me(i,t);o+4<=t;)i=me(i,ie(lt(n,o),3266489917)),i=ie(Se(i,17),668265263),o+=4;for(;o<t;)i=me(i,ie(n[o],374761393)),i=ie(Se(i,11),2654435761),o++;return i^=i>>>15,i=ie(i,2246822519),i^=i>>>13,i=ie(i,3266489917),i^=i>>>16,i>>>0}function Si(n,e=0){let t=new TextEncoder;return En(t.encode(n),e)}function Z(n,e){let t=me(n,ie(e>>>0,3266489917));return t=ie(Se(t,17),668265263),t^=t>>>15,t=ie(t,2246822519),t^=t>>>13,t=ie(t,3266489917),t^=t>>>16,t>>>0}var dt=class{constructor(e,t){this.world=e;this.name=t;this.components=[];this.registered=!1}with(e,t){return this.components.push({type:e,defaults:t}),this.register(),this}_setSyncFields(e){this._syncFields=e}_setOnRestore(e){this._onRestore=e}register(){this.world._registerEntityDef({name:this.name,components:this.components,syncFields:this._syncFields,onRestore:this._onRestore})}_ensureRegistered(){this.registered||(this.registered=!0),this.register()}_getDefinition(){return{name:this.name,components:this.components,syncFields:this._syncFields,onRestore:this._onRestore}}},qe=class{constructor(){this.entityDefs=new Map;this.activeEntities=new Set;this.entityTypes=new Map;this.entityComponents=new Map;this.entityClientIds=new Map;this.inputRegistry=new Map;this._isClient=!0;this.snapshotCodec=new Re;this.frame=0;this.seq=0;this.inputBuffer=new Map;this._isSimulating=!1;this.localClientId=null;this.idAllocator=new ze,this.entityPool=new Ye,this.strings=new Ot,this.queryEngine=new Ue(e=>this.getEntity(e),e=>this.isDestroyed(e)),this.scheduler=new He,this.addSystem(()=>this.saveInterpolationState(),{phase:"prePhysics",order:-1e3})}setIsClient(e){this._isClient=e,this.scheduler.setIsClient(e)}get isClient(){return this._isClient}defineComponent(e,t){return se(e,t)}defineEntity(e){return new dt(this,e)}_registerEntityDef(e){this.entityDefs.set(e.name,e)}getEntityDef(e){return this.entityDefs.get(e)}spawn(e,t={}){let i;if(typeof e=="string")i=e;else{let d=e._getDefinition();this._registerEntityDef(d),i=d.name}let o=this.entityDefs.get(i);if(!o)throw new Error(`Unknown entity type: '${i}'`);let r=this.idAllocator.allocate(),s=r&1048575,a=this.entityPool.acquire(r);this.activeEntities.add(r),this.entityTypes.set(r,i);let c=[];for(let d of o.components){let u=d.type;if(c.push(u),we(u.storage,s),ot(u.storage,s),d.defaults)for(let[h,m]of Object.entries(d.defaults)){let f=u.storage.fields[h];if(f){let y=u.storage.schema[h];y.type==="i32"?f[s]=g(m):y.type==="bool"?f[s]=m?1:0:f[s]=m}}}let l;for(let[d,u]of Object.entries(t)){d==="clientId"&&(l=u,this.entityClientIds.set(r,l));for(let h of c)if(d in h.storage.schema){let m=h.storage.fields[d],f=h.storage.schema[d];f.type==="i32"?m[s]=g(u):f.type==="bool"?m[s]=u?1:0:m[s]=u;break}}if(this.entityComponents.set(r,c),a._init(r,i,c,this),t.x!==void 0||t.y!==void 0){let d=t.x??0,u=t.y??0;a.render.prevX=d,a.render.prevY=u,a.render.interpX=d,a.render.interpY=u}return this.queryEngine.addEntity(r,i,c,l),a}spawnWithId(e,t,i={}){let o;if(typeof e=="string")o=e;else{let u=e._getDefinition();this._registerEntityDef(u),o=u.name}let r=this.entityDefs.get(o);if(!r)throw new Error(`Unknown entity type: '${o}'`);let s=this.idAllocator.allocateSpecific(t),a=s&1048575,c=this.entityPool.acquire(s);this.activeEntities.add(s),this.entityTypes.set(s,o);let l=[];for(let u of r.components){let h=u.type;if(l.push(h),we(h.storage,a),ot(h.storage,a),u.defaults)for(let[m,f]of Object.entries(u.defaults)){let y=h.storage.fields[m];if(y){let x=h.storage.schema[m];x.type==="i32"?y[a]=g(f):x.type==="bool"?y[a]=f?1:0:y[a]=f}}}let d;for(let[u,h]of Object.entries(i)){u==="clientId"&&(d=h,this.entityClientIds.set(s,d));for(let m of r.components){let f=m.type.storage.fields[u];if(f){let y=m.type.storage.schema[u];y.type==="i32"?f[a]=g(h):y.type==="bool"?f[a]=h?1:0:f[a]=h;break}}}if(this.entityComponents.set(s,l),c._init(s,o,l,this),i.x!==void 0||i.y!==void 0){let u=i.x??0,h=i.y??0;c.render.prevX=u,c.render.prevY=h,c.render.interpX=u,c.render.interpY=h}return this.queryEngine.addEntity(s,o,l,d),c}destroyEntity(e){let t=e.eid;if(!this.activeEntities.has(t))return;let i=this.entityTypes.get(t)||"",o=this.entityComponents.get(t)||[],r=this.entityClientIds.get(t),s=t&1048575;for(let a of o)Le(a.storage,s);this.queryEngine.removeEntity(t,i,o,r),this.activeEntities.delete(t),this.entityTypes.delete(t),this.entityComponents.delete(t),this.entityClientIds.delete(t),this.entityPool.release(t),this.idAllocator.free(t)}getEntity(e){if(!this.activeEntities.has(e))return null;let t=this.entityPool.get(e);return t&&!t.destroyed?t:null}isDestroyed(e){return!this.activeEntities.has(e)}getEntityByClientId(e){let t=this.queryEngine.getByClientId(e);return t===void 0?null:this.getEntity(t)}setEntityClientId(e,t){this.entityClientIds.set(e,t),this.queryEngine.setClientId(e,t)}query(e,...t){return this.queryEngine.query(e,...t)}getAllEntities(){let e=[],t=Array.from(this.activeEntities).sort((i,o)=>i-o);for(let i of t){let o=this.entityPool.get(i);o&&e.push(o)}return e}getAllEntityIds(){return Array.from(this.activeEntities).sort((e,t)=>e-t)}addSystem(e,t){return this.scheduler.add(e,t)}runSystems(){this.scheduler.runAll()}internString(e,t){return this.strings.intern(e,t)}getString(e,t){return this.strings.getString(e,t)}setInput(e,t){this.inputRegistry.set(e,t);let i=this.getEntityByClientId(e);i&&i._setInputData(t)}getInput(e){return this.inputRegistry.get(e)}clearInputs(){this.inputRegistry.clear()}getInputState(){let e={};for(let[t,i]of this.inputRegistry)e[t]=i;return e}setInputState(e){this.inputRegistry.clear();for(let[t,i]of Object.entries(e)){let o=parseInt(t,10);this.inputRegistry.set(o,i);let r=this.getEntityByClientId(o);r&&r._setInputData(i)}}getState(){let e=[];for(let t of this.activeEntities){let i=this.entityTypes.get(t),o=this.entityComponents.get(t)||[],r=t&1048575,s={};for(let a of o){let c={};for(let[l,d]of Object.entries(a.storage.fields))c[l]=d[r];s[a.name]=c}e.push({eid:t,type:i,components:s,clientId:this.entityClientIds.get(t)})}return{entities:e,allocator:this.idAllocator.getState(),strings:this.strings.getState()}}setState(e){this.clear(),this.idAllocator.setState(e.allocator),this.strings.setState(e.strings);for(let t of e.entities){let i=this.entityDefs.get(t.type);if(!i){console.warn(`Unknown entity type in snapshot: ${t.type}`);continue}let o=t.eid,r=o&1048575,s=this.entityPool.acquire(o);this.activeEntities.add(o),this.entityTypes.set(o,t.type),t.clientId!==void 0&&this.entityClientIds.set(o,t.clientId);let a=[];for(let c of i.components){let l=c.type;a.push(l),we(l.storage,r);let d=t.components[l.name];if(d)for(let[u,h]of Object.entries(d)){let m=l.storage.fields[u];m&&(m[r]=h)}}this.entityComponents.set(o,a),s._init(o,t.type,a,this),this.queryEngine.addEntity(o,t.type,a,t.clientId)}}clear(){for(let e of this.activeEntities){let t=this.entityComponents.get(e)||[],i=e&1048575;for(let o of t)Le(o.storage,i);this.entityPool.release(e)}this.activeEntities.clear(),this.entityTypes.clear(),this.entityComponents.clear(),this.entityClientIds.clear(),this.queryEngine.clear(),this.idAllocator.reset(),this.strings.clear()}reset(){this.clear()}get entityCount(){return this.activeEntities.size}getSparseSnapshot(){return this.snapshotCodec.encode(Array.from(this.activeEntities),e=>this.entityTypes.get(e)||"",e=>this.entityClientIds.get(e),e=>this.entityComponents.get(e)||[],this.idAllocator.getState(),this.strings.getState(),this.frame,this.seq,pe())}loadSparseSnapshot(e){let t=new Map;for(let i of this.activeEntities){let o=this.entityPool.get(i);o&&t.set(i,{x:o.render.interpX,y:o.render.interpY})}this.snapshotCodec.decode(e,()=>this.clearForSnapshot(),i=>this.idAllocator.setState(i),i=>this.strings.setState(i),(i,o,r)=>this.createEntityFromSnapshot(i,o,r),i=>{i&&he(i)}),this.frame=e.frame,this.seq=e.seq,this.syncRenderStateFromTransforms(t)}syncRenderStateFromTransforms(e){for(let t of this.activeEntities){let i=this.getEntity(t);if(!i)continue;let o=e.get(t);o&&(i.render.prevX=o.x,i.render.prevY=o.y);let r=this.entityComponents.get(t)||[],s=t&1048575;for(let a of r)if(a.name==="Transform2D"){let c=a.storage.fields.x,l=a.storage.fields.y;c&&l&&(i.render.interpX=c[s]/65536,i.render.interpY=l[s]/65536);break}}}clearForSnapshot(){for(let e of this.activeEntities){let t=this.entityComponents.get(e)||[],i=e&1048575;for(let o of t)Le(o.storage,i);this.entityPool.release(e)}this.activeEntities.clear(),this.entityTypes.clear(),this.entityComponents.clear(),this.entityClientIds.clear(),this.queryEngine.clear()}createEntityFromSnapshot(e,t,i){let o=this.entityDefs.get(t);if(!o){console.warn(`Unknown entity type in snapshot: ${t}`);return}let r=e&1048575,s=this.entityPool.acquire(e);this.activeEntities.add(e),this.entityTypes.set(e,t),i!==void 0&&this.entityClientIds.set(e,i);let a=[];for(let c of o.components){let l=c.type;a.push(l),we(l.storage,r)}this.entityComponents.set(e,a),s._init(e,t,a,this),this.queryEngine.addEntity(e,t,a,i)}snapshotToBinary(e){return this.snapshotCodec.toBinary(e)}snapshotFromBinary(e){return this.snapshotCodec.fromBinary(e)}getSnapshotSize(e){return this.snapshotCodec.getSize(e)}tick(e,t=[]){this.frame=e,this.applyNetworkInputs(t),this._isSimulating=!0;try{this.scheduler.runPhase("input"),this.scheduler.runPhase("update"),this.scheduler.runPhase("prePhysics"),this.scheduler.runPhase("physics"),this.scheduler.runPhase("postPhysics")}finally{this._isSimulating=!1}this._isClient&&this.scheduler.runPhase("render"),this.inputBuffer.clear()}applyNetworkInputs(e){for(let t of e){let i=this.getEntityByClientId(t.clientId);if(i){this.inputBuffer.set(t.clientId,t.data);let o=t.data;o&&i._setInputData(o)}}}getInputForClient(e){return this.inputBuffer.get(e)}hasInputForClient(e){return this.inputBuffer.has(e)}runPhysics(){this.scheduler.runPhase("physics")}setPhysicsStep(e){return this.addSystem(e,{phase:"physics",order:0})}saveInterpolationState(){for(let e of this.activeEntities){let t=this.getEntity(e);t&&t._savePreviousState()}}getStateHash(){let e=Array.from(this.activeEntities).sort((i,o)=>i-o),t=0;t=Z(t,e.length);for(let i of e){let o=i&1048575,r=this.entityComponents.get(i)||[];t=Z(t,i>>>0);for(let s of r){if(!s.sync)continue;let a=[...s.fieldNames].sort();for(let c of a){let d=s.storage.fields[c][o];t=Z(t,d>>>0)}}}return t>>>0}getStateHashHex(){return this.getStateHash().toString(16).padStart(8,"0")}};var In={};Dt(In,{decode:()=>Pe,encode:()=>Ae});var Dn=class{constructor(){this.buffer=[]}writeByte(e){this.buffer.push(e&255)}writeUint16(e){this.buffer.push(e>>8&255),this.buffer.push(e&255)}writeUint32(e){this.buffer.push(e>>24&255),this.buffer.push(e>>16&255),this.buffer.push(e>>8&255),this.buffer.push(e&255)}writeInt32(e){this.writeUint32(e>>>0)}writeFloat64(e){let t=new DataView(new ArrayBuffer(8));t.setFloat64(0,e,!1);for(let i=0;i<8;i++)this.buffer.push(t.getUint8(i))}writeString(e){let t=new TextEncoder().encode(e);this.writeUint16(t.length);for(let i=0;i<t.length;i++)this.buffer.push(t[i])}writeValue(e){if(e==null)this.writeByte(0);else if(e===!1)this.writeByte(1);else if(e===!0)this.writeByte(2);else if(typeof e=="number")Number.isInteger(e)?e>=0&&e<=255?(this.writeByte(10),this.writeByte(e)):e>=0&&e<=65535?(this.writeByte(11),this.writeUint16(e)):e>=-2147483648&&e<=2147483647?(this.writeByte(5),this.writeInt32(e)):(this.writeByte(6),this.writeFloat64(e)):(this.writeByte(6),this.writeFloat64(e));else if(typeof e=="string")this.writeByte(7),this.writeString(e);else if(Array.isArray(e)){this.writeByte(8),this.writeUint16(e.length);for(let t of e)this.writeValue(t)}else if(typeof e=="object"){this.writeByte(9);let t=Object.keys(e);this.writeUint16(t.length);for(let i of t)this.writeString(i),this.writeValue(e[i])}else this.writeByte(0)}toUint8Array(){return new Uint8Array(this.buffer)}},Tn=class{constructor(e){this.pos=0;this.data=e}readByte(){return this.data[this.pos++]}readUint16(){let e=this.data[this.pos++],t=this.data[this.pos++];return e<<8|t}readUint32(){let e=this.data[this.pos++],t=this.data[this.pos++],i=this.data[this.pos++],o=this.data[this.pos++];return(e<<24|t<<16|i<<8|o)>>>0}readInt32(){let e=this.readUint32();return e>2147483647?e-4294967296:e}readFloat64(){let e=new DataView(new ArrayBuffer(8));for(let t=0;t<8;t++)e.setUint8(t,this.data[this.pos++]);return e.getFloat64(0,!1)}readString(){let e=this.readUint16(),t=this.data.slice(this.pos,this.pos+e);return this.pos+=e,new TextDecoder().decode(t)}readValue(){switch(this.readByte()){case 0:return null;case 1:return!1;case 2:return!0;case 10:return this.readByte();case 11:return this.readUint16();case 5:return this.readInt32();case 12:return this.readUint32();case 6:return this.readFloat64();case 7:return this.readString();case 8:{let t=this.readUint16(),i=[];for(let o=0;o<t;o++)i.push(this.readValue());return i}case 9:{let t=this.readUint16(),i={};for(let o=0;o<t;o++){let r=this.readString();i[r]=this.readValue()}return i}default:return null}}};function Ae(n){let e=new Dn;return e.writeValue(n),e.toUint8Array()}function Pe(n){return new Tn(n).readValue()}function Ht(n,e){let t=Be(),i=new Map,o=new Map;if(n)for(let d=0;d<n.entityMeta.length;d++){let u=n.entityMeta[d];i.set(u.eid,u);let h={};for(let[m,f]of n.componentData){let y=t.get(m);if(!y)continue;let x={},v=0;for(let C of y.fieldNames){let E=y.storage.fields[C],A=E.BYTES_PER_ELEMENT,D=new E.constructor(f,v,n.entityCount);x[C]=D[d],v+=n.entityCount*A}h[m]=x}o.set(u.eid,h)}let r=new Map,s=new Map;for(let d=0;d<e.entityMeta.length;d++){let u=e.entityMeta[d];r.set(u.eid,u);let h={};for(let[m,f]of e.componentData){let y=t.get(m);if(!y)continue;let x={},v=0;for(let C of y.fieldNames){let E=y.storage.fields[C],A=E.BYTES_PER_ELEMENT,D=new E.constructor(f,v,e.entityCount);x[C]=D[d],v+=e.entityCount*A}h[m]=x}s.set(u.eid,h)}let a=[],c=[],l=[];for(let[d,u]of r){let h=s.get(d);if(!i.has(d))a.push({eid:d,type:u.type,clientId:u.clientId,components:h});else{let m=o.get(d),f={},y=!1;for(let[x,v]of Object.entries(h)){let C=m[x]||{},E={};for(let[A,D]of Object.entries(v))C[A]!==D&&(E[A]=D,y=!0);Object.keys(E).length>0&&(f[x]=E)}y&&c.push({eid:d,changes:f})}}if(n)for(let[d]of i)r.has(d)||l.push(d);return a.sort((d,u)=>d.eid-u.eid),c.sort((d,u)=>d.eid-u.eid),l.sort((d,u)=>d-u),{frame:e.frame,baseHash:n?Ut(n):0,resultHash:Ut(e),created:a,updated:c,deleted:l}}function Ut(n){let e=Be(),t=0;t=Z(t,n.frame),t=Z(t,n.entityCount);for(let i=0;i<n.entityMeta.length;i++){let o=n.entityMeta[i];t=Z(t,o.eid);for(let[r,s]of n.componentData){let a=e.get(r);if(!a)continue;let c=0;for(let l of a.fieldNames){let d=a.storage.fields[l],u=d.BYTES_PER_ELEMENT,m=new d.constructor(s,c,n.entityCount)[i];t=Z(t,m>>>0),c+=n.entityCount*u}}}return t>>>0}function vi(n){let e=JSON.stringify(n);return new TextEncoder().encode(e)}function bi(n){let t=new TextDecoder().decode(n);return JSON.parse(t)}function qt(n,e,t){let i=n.created.filter(l=>ut(l.eid,t)===e),o=n.updated.filter(l=>ut(l.eid,t)===e),r=n.deleted.filter(l=>ut(l,t)===e),s={partitionId:e,numPartitions:t,frame:n.frame,created:i,updated:o,deleted:r},a=JSON.stringify(s);return new TextEncoder().encode(a)}function ut(n,e){return n%e}function Fi(n){let t=new TextDecoder().decode(n);return JSON.parse(t)}function Ci(n){if(n.length===0)return null;let e=n[0].frame,t=n[0].numPartitions;for(let s of n)if(s.frame!==e)return console.warn("Partition frame mismatch"),null;let i=[],o=[],r=[];for(let s of n)i.push(...s.created),o.push(...s.updated),r.push(...s.deleted);return i.sort((s,a)=>s.eid-a.eid),o.sort((s,a)=>s.eid-a.eid),r.sort((s,a)=>s-a),{frame:e,baseHash:0,resultHash:0,created:i,updated:o,deleted:r}}function Ei(n,e,t,i){for(let o of n.deleted)i(o);for(let o of n.created)e(o.eid,o.type,o.clientId,o.components);for(let o of n.updated)t(o.eid,o.changes);return{created:n.created.map(o=>o.eid),updated:n.updated.map(o=>o.eid),deleted:n.deleted}}function Di(n){return n.created.length===0&&n.updated.length===0&&n.deleted.length===0}function Ti(n){let e=16;for(let t of n.created)e+=12,e+=JSON.stringify(t.components).length;for(let t of n.updated)e+=4,e+=JSON.stringify(t.changes).length;return e+=n.deleted.length*4,e}var wn=65536;function Xt(n,e,t,i,o=2){let r=[...e].sort(),s=pt(n,r.length),a=new Map;for(let c=0;c<s;c++){let l=Bn(t,c),d=Rn(r,Math.min(o,r.length),l,i);a.set(c,d)}return{partitionSenders:a,numPartitions:s,frame:t}}function pt(n,e){if(e<=0||n<=0)return 1;let i=Math.ceil(n/30),o=1,r=Math.max(1,e*2);return Math.max(o,Math.min(r,i))}function Bn(n,e){let t=305419896;return t=Z(t,n>>>0),t=Z(t,e>>>0),t>>>0}function Rn(n,e,t,i){if(n.length===0)return[];if(e>=n.length)return[...n];let o=[],r=[...n],s=t;for(let a=0;a<e&&r.length>0;a++){let c=No(r,i),l=ko(c,s);o.push(r[l]),r.splice(l,1),s=zo(s)}return o}function No(n,e){let t=[];for(let i of n){let o=e[i]??50,s=(Math.max(0,Math.min(100,o))+1)*wn|0;t.push(s)}return t}function ko(n,e){if(n.length===0)return-1;if(n.length===1)return 0;let t=0;for(let s of n)t=t+s|0;if(t<=0)return e%n.length;let i=(e>>>0)%wn,o=Lo(i,t),r=0;for(let s=0;s<n.length;s++)if(r=r+n[s]|0,o<r)return s;return n.length-1}function Lo(n,e){let t=BigInt(n>>>0)*BigInt(e>>>0)/BigInt(wn);return Number(t)|0}function zo(n){let e=n>>>0;return e^=e<<13,e^=e>>>17,e^=e<<5,e>>>0}function Ii(n,e,t){return n.partitionSenders.get(t)?.includes(e)??!1}function Wt(n,e){let t=[];for(let[i,o]of n.partitionSenders)o.includes(e)&&t.push(i);return t.sort((i,o)=>i-o)}function wi(n,e,t,i){return e===n&&t===i?"NORMAL":e>n*.75?"DEGRADED":e>n*.25?"MINIMAL":"SKIP"}var Y=!1,ht=class{constructor(e,t,i){this.game=e;this.typeName=t;this.builder=i}spawn(e={}){return this.game.spawn(this.typeName,e)}},mt=class{constructor(){this.physics=null;this.connection=null;this.callbacks={};this.connectedRoomId=null;this.localClientIdStr=null;this.connectedClients=[];this.authorityClientId=null;this.currentFrame=0;this.lastProcessedFrame=0;this.lastInputSeq=0;this.serverFps=20;this.gameLoop=null;this.pendingSnapshotUpload=!1;this.lastSnapshotHash=null;this.lastSnapshotFrame=0;this.lastSnapshotSize=0;this.lastSnapshotEntityCount=0;this.driftStats={determinismPercent:100,totalChecks:0,matchingFieldCount:0,totalFieldCount:0};this.lastSyncPercent=100;this.firstDivergenceFrame=null;this.divergenceHistory=[];this.recentInputs=[];this.lastServerSnapshot={raw:null,decoded:null,frame:0};this.lastGoodSnapshot=null;this.divergenceCaptured=!1;this.divergenceCapture=null;this.lastTickTime=0;this.tickIntervalMs=50;this.reliabilityScores={};this.reliabilityVersion=0;this.activeClients=[];this.prevSnapshot=null;this.stateSyncEnabled=!0;this.deltaBytesThisSecond=0;this.deltaBytesPerSecond=0;this.deltaBytesSampleTime=0;this.clientIdToNum=new Map;this.numToClientId=new Map;this.nextClientNum=1;this.prefabs=new Map;this.collisionHandlers=new Map;this.clientsWithEntitiesFromSnapshot=new Set;this.renderer=null;this.plugins=new Map;this.world=new qe}addPlugin(e,...t){let i=new e(this,...t),o=e.name||"anonymous";return this.plugins.set(o,i),i}getPlugin(e){return this.plugins.get(e.name)}get frame(){return this.currentFrame}get time(){return this.currentFrame*this.tickIntervalMs}defineEntity(e){return new An(this,e)}_registerPrefab(e,t){let i=new ht(this,e,t);return this.prefabs.set(e,i),i}spawn(e,t={}){let i={...t};return t.clientId&&typeof t.clientId=="string"&&(i.clientId=this.internClientId(t.clientId)),this.world.spawn(e,i)}getPrefab(e){return this.prefabs.get(e)}query(e){return this.world.query(e)}getEntitiesByType(e){return this.world.query(e).toArray()}getAllEntities(){return this.world.getAllEntities()}getEntityByClientId(e){let t=this.clientIdToNum.get(e);return t===void 0?null:this.world.getEntityByClientId(t)}getPlayer(e){return this.getEntityByClientId(e)}getPlayers(){return this.world.query(ae).toArray()}addSystem(e,t){return this.world.addSystem(e,t)}onCollision(e,t,i){if(this.physics)this.physics.onCollision(e,t,i);else{let o=`${e}:${t}`;this.collisionHandlers.set(o,i)}return this}internClientId(e){let t=this.clientIdToNum.get(e);return t===void 0&&(t=this.nextClientNum++,this.clientIdToNum.set(e,t),this.numToClientId.set(t,e)),t}getClientIdString(e){return this.numToClientId.get(e)}internString(e,t){return this.world.internString(e,t)}getString(e,t){return this.world.getString(e,t)}getStateHash(){return this.world.getStateHash()}getStateHashHex(){return this.world.getStateHashHex()}reset(){this.world.reset(),this.currentFrame=0}async connect(e,t,i={}){if(this.callbacks=t,typeof window<"u"){let r=new URLSearchParams(window.location.search);r.get("room")&&(e=r.get("room")),r.get("nodeUrl")&&(i.nodeUrl=r.get("nodeUrl"))}this.connectedRoomId=e;let o=window.moduNetwork;if(!o)throw new Error("moduNetwork not found. Include modu-network SDK before calling connect().");console.log(`[ecs] Connecting to room "${e}"...`);try{this.connection=await o.connect(e,{nodeUrl:i.nodeUrl,centralServiceUrl:i.centralServiceUrl,appId:"dev",joinToken:i.joinToken,onConnect:(r,s,a,c,l,d)=>{this.handleConnect(r,s,a,l,d)},onTick:(r,s)=>{this.handleTick(r,s)},onDisconnect:()=>{this.handleDisconnect()},onBinarySnapshot:r=>{this.handleServerSnapshot(r)},onError:r=>{console.error("[ecs] Network error:",r)}}),this.localClientIdStr=this.connection.clientId,this.connection.onReliabilityUpdate!==void 0&&(this.connection.onReliabilityUpdate=(r,s)=>{this.handleReliabilityUpdate(r,s)}),this.connection.onMajorityHash!==void 0&&(this.connection.onMajorityHash=(r,s)=>{this.handleMajorityHash(r,s)})}catch(r){console.warn("[ecs] Connection failed:",r?.message||r),this.connection=null,this.connectedRoomId=null}}handleReliabilityUpdate(e,t){t<=this.reliabilityVersion||(this.reliabilityScores=e,this.reliabilityVersion=t)}handleMajorityHash(e,t){let i=this.world.getStateHash();i!==t&&console.warn(`[state-sync] Hash mismatch at frame ${e}: local=${i.toString(16)} majority=${t.toString(16)}`)}handleConnect(e,t,i,o,r){let s=0;if(e instanceof Uint8Array)if(s=e.length,e.length<2)e=null;else try{e=Pe(e)?.snapshot||null}catch(c){console.error("[ecs] Failed to decode snapshot:",c),e=null}if(this.localClientIdStr=r,this.serverFps=o,this.tickIntervalMs=1e3/o,this.currentFrame=i,e?.hash!==void 0&&(this.lastSnapshotHash=typeof e.hash=="number"?e.hash:parseInt(String(e.hash),16)||0,this.lastSnapshotFrame=e.frame||i,this.lastSnapshotSize=s,this.lastSnapshotEntityCount=e.entities?.length||0),Y&&(console.log(`[ecs] Connected as ${r}, frame ${i}, fps ${o}`),console.log("[ecs] Snapshot:",e?{frame:e.frame,entityCount:e.entities?.length}:"none"),console.log(`[ecs] Inputs: ${t.length}`)),e?.entities&&e.entities.length>0){Y&&console.log(`[ecs] Late join: restoring snapshot frame=${e.frame}`),this.currentFrame=e.frame||i,this.loadNetworkSnapshot(e);for(let y of t)this.processAuthorityChainInput(y);let c=pe();this.callbacks.onSnapshot&&this.callbacks.onSnapshot(this.world.getAllEntities()),he(c);let l=e.seq||0,d=t.filter(y=>y.seq>l).sort((y,x)=>y.seq-x.seq),u=this.currentFrame,m=e.postTick===!0?u+1:u,f=i-m+1;Y&&console.log(`[ecs] Catchup: from ${m} to ${i} (${f} ticks), ${d.length} pending inputs`),f>0&&this.runCatchup(m,i,d),this.lastGoodSnapshot={snapshot:JSON.parse(JSON.stringify(e)),frame:this.currentFrame,hash:this.getStateHash()}}else{Y&&console.log("[ecs] First join: creating room"),this.currentFrame=i,this.authorityClientId=r,this.connectedClients.includes(r)||this.connectedClients.push(r),this.callbacks.onRoomCreate?.();for(let c of t)this.processInput(c)}this.checkIsAuthority()&&this.sendSnapshot("init"),this.startGameLoop(),Y&&console.log("[ecs] Game loop started")}handleTick(e,t){if(e<=this.lastProcessedFrame){Y&&console.log(`[ecs] Skipping old frame ${e} (already at ${this.lastProcessedFrame})`);return}if(this.currentFrame=e,this.lastProcessedFrame=e,Y&&t.length>0){let o=t.map(r=>r.data?.type||"game").join(",");console.log(`[ecs] onTick frame=${e}: ${t.length} inputs (${o})`)}let i=t.length>1?[...t].sort((o,r)=>(o.seq||0)-(r.seq||0)):t;for(let o of i)this.processInput(o);this.world.tick(e,[]),this.callbacks.onTick?.(e),this.pendingSnapshotUpload&&this.checkIsAuthority()&&(this.sendSnapshot("join"),this.pendingSnapshotUpload=!1),this.lastTickTime=typeof performance<"u"?performance.now():Date.now(),this.sendStateSync(e)}sendStateSync(e){if(!this.stateSyncEnabled||!this.connection?.sendStateHash)return;let t=typeof performance<"u"?performance.now():Date.now();t-this.deltaBytesSampleTime>=1e3&&(this.deltaBytesPerSecond=this.deltaBytesThisSecond,this.deltaBytesThisSecond=0,this.deltaBytesSampleTime=t);let i=this.world.getStateHash();if(this.connection.sendStateHash(e,i),this.deltaBytesThisSecond+=9,this.activeClients.length>0&&this.connection.clientId){let o=this.world.entityCount,r=pt(o,this.activeClients.length),s=Xt(o,this.activeClients,e,this.reliabilityScores),a=Wt(s,this.connection.clientId);if(a.length>0&&this.connection.sendPartitionData){let c=this.world.getSparseSnapshot(),l=Ht(this.prevSnapshot,c);for(let d of a){let u=qt(l,d,r);this.connection.sendPartitionData(e,d,u),this.deltaBytesThisSecond+=8+u.length}this.prevSnapshot=c}}}processInput(e){let t=e.data;if(t instanceof Uint8Array)try{t=Pe(t)}catch(r){console.warn("[ecs] Failed to decode input:",r);return}let i=t?.clientId||e.clientId,o=t?.type;if(this.recentInputs.push({frame:this.currentFrame,seq:e.seq,clientId:i,data:JSON.parse(JSON.stringify(t))}),this.recentInputs.length>500&&this.recentInputs.shift(),e.seq>this.lastInputSeq&&(this.lastInputSeq=e.seq),o==="join"){this.connectedClients.includes(i)||this.connectedClients.push(i),this.activeClients.includes(i)||(this.activeClients.push(i),this.activeClients.sort()),this.authorityClientId===null&&(this.authorityClientId=i),Y&&console.log(`[ecs] Join: ${i.slice(0,8)}, authority=${this.authorityClientId?.slice(0,8)}`);let r=pe();this.clientsWithEntitiesFromSnapshot.has(i)?Y&&console.log(`[ecs] Skipping onConnect for ${i.slice(0,8)} - already has entity from snapshot`):this.callbacks.onConnect?.(i),he(r),this.checkIsAuthority()&&(this.pendingSnapshotUpload=!0)}else if(o==="leave"||o==="disconnect"){let r=this.connectedClients.indexOf(i);r!==-1&&this.connectedClients.splice(r,1);let s=this.activeClients.indexOf(i);s!==-1&&this.activeClients.splice(s,1),i===this.authorityClientId&&(this.authorityClientId=this.connectedClients[0]||null),Y&&console.log(`[ecs] Leave: ${i.slice(0,8)}, new authority=${this.authorityClientId?.slice(0,8)}`);let a=pe();this.callbacks.onDisconnect?.(i),he(a)}else t&&this.routeInputToEntity(i,t)}routeInputToEntity(e,t){let i=this.internClientId(e);if(this.world.setInput(i,t),Y){let o=this.world.getEntityByClientId(i);console.log(`[ecs] routeInput: clientId=${e.slice(0,8)}, numId=${i}, entity=${o?.eid||"null"}, data=${JSON.stringify(t)}`)}}processAuthorityChainInput(e){let t=e.data;if(t instanceof Uint8Array)try{t=Pe(t)}catch{return}let i=t?.clientId||e.clientId,o=t?.type;if(o==="join")this.connectedClients.includes(i)||this.connectedClients.push(i),this.authorityClientId===null&&(this.authorityClientId=i);else if(o==="leave"||o==="disconnect"){let r=this.connectedClients.indexOf(i);r!==-1&&this.connectedClients.splice(r,1),i===this.authorityClientId&&(this.authorityClientId=this.connectedClients[0]||null)}}runCatchup(e,t,i){let o=t-e+1;Y&&console.log(`[ecs] Catchup: ${o} ticks from ${e} to ${t}, ${i.length} inputs`);let r=[...i].sort((a,c)=>(a.seq||0)-(c.seq||0)),s=new Map;for(let a of r){let c=a.frame??e;s.has(c)||s.set(c,[]),s.get(c).push(a)}for(let a=0;a<o;a++){let c=e+a;this.currentFrame=c;let l=s.get(c)||[];for(let d of l)this.processInput(d);this.world.tick(c,[]),this.callbacks.onTick?.(c)}this.currentFrame=t,this.lastProcessedFrame=t,this.clientsWithEntitiesFromSnapshot.clear(),Y&&console.log(`[ecs] Catchup complete at frame ${this.currentFrame}, hash=${this.getStateHash()}`)}getNetworkSnapshot(){let e=[],t=new Map,i=[],o=new Map,r=[];for(let c of this.world.getAllEntities()){let l=c.eid&1048575,d=c.type;if(!t.has(d)){let m=e.length;e.push(d),t.set(d,m);let f=this.world.getEntityDef(d),y=f?.syncFields?new Set(f.syncFields):null;o.set(d,y);let x=[];for(let v of c.getComponents()){let C=y?v.fieldNames.filter(E=>y.has(E)):v.fieldNames;C.length>0&&x.push([v.name,C])}i.push(x)}let u=o.get(d),h=[];for(let m of c.getComponents())for(let f of m.fieldNames)(!u||u.has(f))&&h.push(m.storage.fields[f][l]);r.push([c.eid,t.get(d),h])}let s=0,a={};for(let c of r){let l=c[0],d=l&1048575,u=l>>>20;d>=s&&(s=d+1),a[d]=u}return{frame:this.currentFrame,seq:this.lastInputSeq,postTick:!0,format:5,types:e,schema:i,entities:r,idAllocatorState:{nextIndex:s,freeList:[],generations:a},rng:pe(),strings:this.world.strings.getState(),clientIdMap:{toNum:Object.fromEntries(this.clientIdToNum),nextNum:this.nextClientNum},inputState:this.world.getInputState()}}loadNetworkSnapshot(e){Y&&console.log(`[ecs] Loading snapshot: ${e.entities?.length} entities`),this.world.reset(),this.physics&&this.physics.clear(),e.rng&&he(e.rng),e.strings&&this.world.strings.setState(e.strings),e.clientIdMap&&(this.clientIdToNum=new Map(Object.entries(e.clientIdMap.toNum).map(([s,a])=>[s,a])),this.numToClientId=new Map(Array.from(this.clientIdToNum.entries()).map(([s,a])=>[a,s])),this.nextClientNum=e.clientIdMap.nextNum||1);let t=e.types,i=e.schema,o=e.entities,r=new Map;for(let s of o){let[a,c,l]=s,d=t[c],u=i[c],h;try{h=this.world.spawnWithId(d,a,{})}catch(y){console.warn(`[ecs] Failed to spawn ${d} with eid ${a}:`,y);continue}r.has(d)||r.set(d,[]),r.get(d).push(h);let m=a&1048575,f=0;for(let[y,x]of u)for(let v of h.getComponents())if(v.name===y){for(let C of x)v.storage.fields[C][m]=l[f++];break}if(h.has(ae)){let y=h.get(ae);y.clientId!==0&&this.world.setEntityClientId(h.eid,y.clientId)}}for(let[s,a]of r){let c=this.world.getEntityDef(s);if(c?.onRestore)for(let l of a)c.onRestore(l,this)}if(this.lastInputSeq=e.seq||0,e.idAllocatorState){let s=e.idAllocatorState;if(e.format>=3&&typeof s.generations=="object"&&!Array.isArray(s.generations)){this.world.idAllocator.reset(),this.world.idAllocator.setNextId(s.nextIndex);for(let[c,l]of Object.entries(s.generations)){let d=parseInt(c,10);this.world.idAllocator.generations[d]=l}let a=[];for(let c=0;c<s.nextIndex;c++)c.toString()in s.generations||a.push(c);this.world.idAllocator.freeList=a}else this.world.idAllocator.setState(s)}this.clientsWithEntitiesFromSnapshot.clear();for(let s of this.world.query(ae)){let a=s.get(ae);if(a.clientId!==0){let c=this.getClientIdString(a.clientId);c&&(this.clientsWithEntitiesFromSnapshot.add(c),Y&&console.log(`[ecs] Snapshot has entity for client ${c.slice(0,8)}`))}}if(this.physics&&this.physics.wakeAllBodies(),e.inputState&&this.world.setInputState(e.inputState),Y){console.log(`[ecs] Snapshot loaded: ${this.world.getAllEntities().length} entities, hash=${this.getStateHash()}`);let s=this.world.getAllEntities()[0];if(s){let a={};for(let c of s.getComponents()){let l={};for(let d of c.fieldNames)l[d]=s.get(c)[d];a[c.name]=l}console.log(`[ecs] Restored first entity: type=${s.type}, components=`,JSON.stringify(a))}}}sendSnapshot(e){if(!this.connection)return;this.physics&&this.physics.wakeAllBodies();let t=this.getNetworkSnapshot(),i=this.world.getStateHash(),o=Ae({snapshot:t,hash:i}),r=Ae(t.entities).length,s=Ae(t.schema).length,a=t.entities.length;console.log(`[SNAPSHOT-SIZE] Total: ${o.length}B | entities: ${r}B (${a}) | schema: ${s}B`),Y&&console.log(`[ecs] Sending snapshot (${e}): ${o.length} bytes, ${a} entities, hash=${i}`),this.connection.sendSnapshot(o,i,t.seq,t.frame),this.lastSnapshotHash=i,this.lastSnapshotFrame=t.frame,this.lastSnapshotSize=o.length,this.lastSnapshotEntityCount=a}handleServerSnapshot(e){Y&&console.log(`[ecs] Received server snapshot: ${e.length} bytes`);try{let t=Pe(e),i=t?.snapshot,o=t?.hash;if(i)if(this.lastSnapshotHash=typeof o=="number"?o:(o?parseInt(String(o),16):null)||null,this.lastSnapshotFrame=i.frame,this.lastSnapshotSize=e.length,this.lastSnapshotEntityCount=i.entities?.length||0,this.currentFrame===i.frame){this.compareSnapshotFields(i);let r=this.getStateHash();r!==o&&console.warn(`[ecs] DRIFT detected at frame ${i.frame}: local=${r}, server=${o}`)}else this.driftStats={determinismPercent:100,totalChecks:0,matchingFieldCount:0,totalFieldCount:0}}catch(t){console.warn("[ecs] Failed to decode server snapshot:",t)}}compareSnapshotFields(e){let t=e.frame,i=0,o=0,r=[];this.lastServerSnapshot={raw:null,decoded:e,frame:t};let s=e.types||[],a=e.entities||[],c=e.schema||[],l=new Map;for(let m of a)l.set(m[0],m);for(let m of this.world.getAllEntities()){let f=m.eid,y=l.get(f),x=f&1048575;if(!y){for(let D of m.getComponents()){o+=D.fieldNames.length;for(let R of D.fieldNames)r.push({entity:m.type,eid:f,comp:D.name,field:R,local:"EXISTS",server:"MISSING"})}continue}let[,v,C]=y,E=c[v];if(!E)continue;let A=0;for(let[D,R]of E){let O=m.getComponents().find(L=>L.name===D);for(let L of R){o++;let q=C[A++];if(O){let X=O.storage.fields[L][x],Fe=O.schema[L],T=!1;Fe?.type==="bool"?T=X!==0===(q!==0&&q!==!1):T=X===q,T?i++:r.push({entity:m.type,eid:f,comp:D,field:L,local:X,server:q})}}}}for(let[m,f]of l)if(this.world.getEntity(m)===null){let[,y,x]=f,v=s[y]||`type${y}`;o+=x.length,r.push({entity:v,eid:m,comp:"*",field:"*",local:"MISSING",server:"EXISTS"})}let d=o>0?i/o*100:100,u=this.lastSyncPercent===100,h=d===100;if(h&&(this.lastGoodSnapshot={snapshot:JSON.parse(JSON.stringify(e)),frame:t,hash:this.getStateHash()}),u&&!h&&!this.divergenceCaptured){this.firstDivergenceFrame=t,this.divergenceHistory=[],this.divergenceCaptured=!0;let m=this.lastGoodSnapshot?.frame??0,f=this.recentInputs.filter(x=>x.frame>m&&x.frame<=t),y=this.world.getState();this.divergenceCapture={lastGoodSnapshot:this.lastGoodSnapshot?.snapshot??null,lastGoodFrame:m,inputs:f,localSnapshot:y,serverSnapshot:e,diffs:r,divergenceFrame:t,clientId:this.localClientIdStr,isAuthority:this.checkIsAuthority()},this.showDivergenceDiff(r,f,t)}this.lastSyncPercent=d,this.driftStats.totalChecks++,this.driftStats.matchingFieldCount=i,this.driftStats.totalFieldCount=o,this.driftStats.determinismPercent=d,r.length>0&&d<100&&this.divergenceCaptured&&t%60===0&&console.warn(`[DIVERGENCE] Frame ${t}: still diverged (${d.toFixed(1)}% sync, first at ${this.firstDivergenceFrame})`)}showDivergenceDiff(e,t,i){let o=[],r=this.lastGoodSnapshot?.frame??0,s=this.localClientIdStr||"",a=new Set;for(let u of t)a.add(u.clientId);let c=Array.from(a),l=new Map;c.forEach((u,h)=>{let m=u===s?"ME":`P${h+1}`;l.set(u,m)});let d=new Map;for(let u of this.world.getAllEntities())if(u.has(ae)){let h=u.get(ae),m=this.numToClientId.get(h.clientId);m&&d.set(u.eid,l.get(m)||m.slice(0,8))}o.push("=== DIVERGENCE DEBUG DATA ==="),o.push(`Frame: ${i} | Last good: ${r} | Authority: ${this.checkIsAuthority()}`),o.push(`Clients: ${c.map(u=>`${l.get(u)}=${u.slice(0,8)}`).join(", ")}`),o.push(""),o.push(`DIVERGENT FIELDS (${e.length}):`);for(let u of e){let h=typeof u.local=="number"&&typeof u.server=="number"?` \u0394${u.local-u.server}`:"",m=d.get(u.eid),f=m?` [${m}]`:"";o.push(`  ${u.entity}#${u.eid.toString(16)}${f}.${u.comp}.${u.field}: local=${u.local} server=${u.server}${h}`)}o.push(""),o.push(`INPUTS (${t.length}):`);for(let u of t){let h=l.get(u.clientId)||u.clientId.slice(0,8);o.push(`  f${u.frame} [${h}]: ${JSON.stringify(u.data)}`)}if(o.push(""),this.lastGoodSnapshot){let u=Object.keys(this.lastGoodSnapshot.snapshot.entities||{}).length;o.push(`LAST GOOD SNAPSHOT (f${r}): ${u} entities`)}else o.push("LAST GOOD SNAPSHOT: none (never had 100% sync)");if(this.lastServerSnapshot.decoded){let u=Object.keys(this.lastServerSnapshot.decoded.entities||{}).length;o.push(`SERVER SNAPSHOT (f${this.lastServerSnapshot.frame}): ${u} entities`)}o.push("=== END DEBUG DATA ==="),o.push("To get detailed replay data: game.getDivergenceReplay()"),console.error(o.join(`
`))}getDivergenceReplay(){if(!this.divergenceCapture){console.warn("[REPLAY] No divergence captured yet.");return}let e=JSON.stringify(this.divergenceCapture,null,2),t=new Blob([e],{type:"application/json"}),i=URL.createObjectURL(t),o=document.createElement("a");o.href=i,o.download=`divergence-${this.divergenceCapture.divergenceFrame}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(i),console.log(`[REPLAY] Downloaded (${(e.length/1024).toFixed(1)} KB)`)}startGameLoop(){if(this.gameLoop)return;let e=()=>{this.renderer?.render?this.renderer.render():this.callbacks.render&&this.callbacks.render(),this.gameLoop=requestAnimationFrame(e)};this.gameLoop=requestAnimationFrame(e)}stopGameLoop(){this.gameLoop&&(cancelAnimationFrame(this.gameLoop),this.gameLoop=null)}handleDisconnect(){Y&&console.log("[ecs] Disconnected"),this.stopGameLoop()}checkIsAuthority(){if(this.localClientIdStr===null||this.authorityClientId===null)return!1;let e=Math.min(this.localClientIdStr.length,this.authorityClientId.length);return this.localClientIdStr.substring(0,e)===this.authorityClientId.substring(0,e)}isAuthority(){return this.checkIsAuthority()}isConnected(){return this.connection!==null}getFrame(){return this.currentFrame}getServerFps(){return this.serverFps}getRenderAlpha(){if(this.lastTickTime===0)return 1;let t=(typeof performance<"u"?performance.now():Date.now())-this.lastTickTime;return Math.min(t/this.tickIntervalMs,1)}sendInput(e){if(!this.connection)return;let t=Ae(e);this.connection.send(t)}leaveRoom(){this.connection&&(this.connection.leaveRoom(),this.connection=null,this.stopGameLoop())}get localClientId(){return this.localClientIdStr}setLocalClientId(e){this.localClientIdStr=e;let t=this.internClientId(e);this.world.localClientId=t}getRoomId(){return this.connectedRoomId}getLastSnapshot(){return{hash:this.lastSnapshotHash,frame:this.lastSnapshotFrame,size:this.lastSnapshotSize,entityCount:this.lastSnapshotEntityCount}}getClients(){return this.connectedClients}getClientId(){return this.localClientIdStr}getNodeUrl(){return null}getUploadRate(){return this.connection?.bandwidthOut||0}getDownloadRate(){return this.connection?.bandwidthIn||0}getDriftStats(){if(this.driftStats.totalChecks===0){let e=this.world.getAllEntities().length,t=0;for(let i of this.world.getAllEntities())for(let o of i.getComponents())t+=o.fieldNames.length;return{determinismPercent:100,totalChecks:0,matchingFieldCount:t,totalFieldCount:t}}return{...this.driftStats}}setRenderer(e){this.renderer=e}getCanvas(){return this.renderer?.element??null}getReliabilityScores(){return{...this.reliabilityScores}}getActiveClients(){return[...this.activeClients]}getEntityCount(){return this.world.entityCount}getDeltaBandwidth(){return this.deltaBytesPerSecond}},An=class{constructor(e,t){this.game=e;this.name=t;this.inputCommandsDef=null;this.worldBuilder=e.world.defineEntity(t)}with(e,t){return this.worldBuilder.with(e,t),this}commands(e){return this.inputCommandsDef=e,this}syncOnly(e){return this.worldBuilder._setSyncFields(e),this}syncNone(){return this.worldBuilder._setSyncFields([]),this}sync(e){return this.syncOnly(e)}onRestore(e){return this.worldBuilder._setOnRestore(e),this}register(){return this.worldBuilder._ensureRegistered(),this.game._registerPrefab(this.name,this.worldBuilder)}};function Bi(){return new mt}var ft=class{constructor(e,t,i={}){this.imageCache=new Map;this._cameraEntity=null;if(this.game=e,typeof t=="string"){let r=document.querySelector(t);if(!r)throw new Error(`Canvas not found: ${t}`);this.canvas=r}else this.canvas=t;let o=this.canvas.getContext("2d");if(!o)throw new Error("Could not get 2d context");this.ctx=o,this.options={background:i.background??"#111",autoClear:i.autoClear??!0},e.setRenderer(this)}get width(){return this.canvas.width}get height(){return this.canvas.height}get element(){return this.canvas}get context(){return this.ctx}set camera(e){if(this._cameraEntity=e,e)try{let t=e.get(ee);t.viewportWidth=this.canvas.width,t.viewportHeight=this.canvas.height}catch{}}get camera(){return this._cameraEntity}render(){let{ctx:e,canvas:t,options:i,game:o}=this;i.autoClear&&(e.fillStyle=i.background,e.fillRect(0,0,t.width,t.height));let r=o.getRenderAlpha(),s=0,a=0,c=1;if(this._cameraEntity&&!this._cameraEntity.destroyed)try{let d=this._cameraEntity.get(ee);s=d.x,a=d.y,c=d.zoom,d.viewportWidth=t.width,d.viewportHeight=t.height}catch{}let l=[];for(let d of o.getAllEntities())if(!d.destroyed)try{let u=d.get(rt);u&&u.visible&&(d.interpolate(r),l.push({entity:d,layer:u.layer}))}catch{}l.sort((d,u)=>d.layer-u.layer),e.save(),e.translate(t.width/2,t.height/2),e.scale(c,c),e.translate(-s,-a);for(let{entity:d}of l)this.drawEntity(d);e.restore()}drawEntity(e){let{ctx:t,game:i}=this,o=e.get(rt),r=e.render.interpX+o.offsetX,s=e.render.interpY+o.offsetY,a=o.scaleX,c=o.scaleY,l=i.getString("color",o.color)||"#fff";t.save(),t.translate(r,s),t.scale(a,c);let d=o.shape;if(d===Oe){let u=o.radius;t.fillStyle=l,t.beginPath(),t.arc(0,0,u,0,Math.PI*2),t.fill()}else if(d===Lt){let u=o.width,h=o.height;t.fillStyle=l,t.fillRect(-u/2,-h/2,u,h)}else if(d===kt){let u=i.getString("sprite",o.spriteId);if(u){let h=this.getImage(u);if(h&&h.complete){let m=o.width||h.width,f=o.height||h.height;t.drawImage(h,-m/2,-f/2,m,f)}}}t.restore()}getImage(e){let t=this.imageCache.get(e);return t||(t=new Image,t.src=e,this.imageCache.set(e,t)),t}preload(e){return Promise.all(e.map(t=>new Promise(i=>{let o=this.getImage(t);o?.complete?i():o&&(o.onload=()=>i(),o.onerror=()=>i())}))).then(()=>{})}};var $t=class{constructor(e,t){this.actions=new Map;this.bindings=new Map;this.mousePos={x:0,y:0};this.keysDown=new Set;this.mouseButtons=new Set;this.sendInterval=null;if(this.game=e,typeof t=="string"){let i=document.querySelector(t);if(!i)throw new Error(`Canvas not found: ${t}`);this.canvas=i}else this.canvas=t;this.setupListeners(),this.startSendLoop()}action(e,t){return this.actions.set(e,t),this.bindings.has(e)||this.bindings.set(e,[...t.bindings]),this}rebind(e,t){return this.actions.has(e)?(this.bindings.set(e,t),this):(console.warn(`[InputPlugin] Unknown action: ${e}`),this)}resetBinding(e){let t=this.actions.get(e);return t&&this.bindings.set(e,[...t.bindings]),this}resetAllBindings(){for(let[e,t]of this.actions)this.bindings.set(e,[...t.bindings]);return this}getBindings(){let e={};for(let[t,i]of this.bindings)e[t]=i.filter(o=>typeof o=="string");return e}loadBindings(e){for(let[t,i]of Object.entries(e))this.actions.has(t)&&this.bindings.set(t,i);return this}isKeyDown(e){return this.keysDown.has(e.toLowerCase())}get(e){let t=this.actions.get(e),i=this.bindings.get(e);return!t||!i?null:t.type==="button"?this.resolveButton(i):this.resolveVector(i)}getAll(){let e={};for(let t of this.actions.keys())e[t]=this.get(t);return e}resolveButton(e){for(let t of e)if(typeof t=="function"){if(t())return!0}else if(this.resolveStringButton(t))return!0;return!1}resolveVector(e){let t=0,i=0;for(let o of e){let r=null;typeof o=="function"?r=o():r=this.resolveStringVector(o),r&&(t+=r.x,i+=r.y)}return{x:t,y:i}}resolveStringButton(e){if(e.startsWith("key:")){let t=e.slice(4).toLowerCase();return this.keysDown.has(t)}if(e.startsWith("mouse:")){let t=e.slice(6);if(t==="left")return this.mouseButtons.has(0);if(t==="right")return this.mouseButtons.has(2);if(t==="middle")return this.mouseButtons.has(1)}return!1}resolveStringVector(e){return e==="mouse"?{...this.mousePos}:null}getMousePos(){return{...this.mousePos}}isMouseButtonDown(e){return this.mouseButtons.has(e)}setupListeners(){this.canvas.addEventListener("mousemove",e=>{let t=this.canvas.getBoundingClientRect();this.mousePos.x=e.clientX-t.left,this.mousePos.y=e.clientY-t.top}),this.canvas.addEventListener("mousedown",e=>{this.mouseButtons.add(e.button)}),this.canvas.addEventListener("mouseup",e=>{this.mouseButtons.delete(e.button)}),window.addEventListener("keydown",e=>{this.keysDown.add(e.key.toLowerCase())}),window.addEventListener("keyup",e=>{this.keysDown.delete(e.key.toLowerCase())}),window.addEventListener("blur",()=>{this.keysDown.clear(),this.mouseButtons.clear()})}startSendLoop(){let e=1e3/(this.game.getServerFps?.()||20);this.sendInterval=window.setInterval(()=>{if(this.game.isConnected()&&this.game.localClientId&&this.actions.size>0){let t=this.getAll();this.game.sendInput(t)}},e)}destroy(){this.sendInterval!==null&&(clearInterval(this.sendInterval),this.sendInterval=null)}};var Gt=class{constructor(e,t={}){this.game=e,this.options={defaultZoom:t.defaultZoom??1,defaultSmoothing:t.defaultSmoothing??.1,minZoom:t.minZoom??.1,maxZoom:t.maxZoom??10},e.addSystem(this.update.bind(this),{phase:"render"})}update(){for(let e of this.game.query("Camera2D"))this.updateCamera(e)}updateCamera(e){let t=e.get(ee);if(t.followEntity!==0){let i=this.game.world.getEntity(t.followEntity);if(i&&!i.destroyed)try{let o=i.get(W);t.x+=(o.x-t.x)*t.smoothing,t.y+=(o.y-t.y)*t.smoothing}catch{}}t.zoom!==t.targetZoom&&(t.zoom+=(t.targetZoom-t.zoom)*t.smoothing,t.zoom=Math.max(this.options.minZoom,Math.min(this.options.maxZoom,t.zoom)))}follow(e,t){let i=e.get(ee);i.followEntity=t?t.eid:0}centerOn(e,t,i){if(t.length===0)return;let o=e.get(ee),r=0,s=0,a=0;for(let c=0;c<t.length;c++){let l=t[c];if(!l.destroyed)try{let d=l.get(W),u=i?.[c]??1;s+=d.x*u,a+=d.y*u,r+=u}catch{}}r>0&&(o.x+=(s/r-o.x)*o.smoothing,o.y+=(a/r-o.y)*o.smoothing)}worldToScreen(e,t,i){let o=e.get(ee);return{x:(t-o.x)*o.zoom+o.viewportWidth/2,y:(i-o.y)*o.zoom+o.viewportHeight/2}}screenToWorld(e,t,i){let o=e.get(ee);return{x:(t-o.viewportWidth/2)/o.zoom+o.x,y:(i-o.viewportHeight/2)/o.zoom+o.y}}setZoom(e,t,i=!1){let o=e.get(ee),r=Math.max(this.options.minZoom,Math.min(this.options.maxZoom,t));o.targetZoom=r,i&&(o.zoom=r)}getVisibleBounds(e){let t=e.get(ee),i=t.viewportWidth/2/t.zoom,o=t.viewportHeight/2/t.zoom;return{left:t.x-i,top:t.y-o,right:t.x+i,bottom:t.y+o}}isPointVisible(e,t,i,o=0){let r=this.getVisibleBounds(e);return t>=r.left-o&&t<=r.right+o&&i>=r.top-o&&i<=r.bottom+o}};var H={},Zt=null,Qt=new Set;function jt(){return Zt?.world?._isSimulating??!1}function Kt(n,e){Qt.has(n)||(Qt.add(n),console.warn(e))}function Jt(n){if(Zt){console.warn("Determinism guard already installed for another game instance");return}Zt=n,Qt.clear(),H.mathRandom=Math.random,Math.random=function(){return jt()&&Kt("Math.random",`\u26A0\uFE0F Math.random() is non-deterministic!
   Use dRandom() instead for deterministic random numbers.
   Example: const r = dRandom();`),H.mathRandom()},H.mathSqrt=Math.sqrt,Math.sqrt=function(e){return jt()&&Kt("Math.sqrt",`\u26A0\uFE0F Math.sqrt() is non-deterministic!
   Use dSqrt() instead for deterministic square root.
   Example: const dist = dSqrt(dx * dx + dy * dy);`),H.mathSqrt(e)},H.dateNow=Date.now,Date.now=function(){return jt()&&Kt("Date.now",`\u26A0\uFE0F Date.now() is non-deterministic!
   Use game.time instead for deterministic timing.
   Example: const respawnAt = game.time + 3000;`),H.dateNow()},typeof performance<"u"&&(H.performanceNow=performance.now.bind(performance),performance.now=function(){return jt()&&Kt("performance.now",`\u26A0\uFE0F performance.now() is non-deterministic!
   Use game.time instead for deterministic timing.`),H.performanceNow()}),console.log("\u{1F6E1}\uFE0F Determinism guard enabled")}function Ri(){H.mathRandom&&(Math.random=H.mathRandom),H.mathSqrt&&(Math.sqrt=H.mathSqrt),H.dateNow&&(Date.now=H.dateNow),H.performanceNow&&typeof performance<"u"&&(performance.now=H.performanceNow),Zt=null,Qt.clear(),Object.keys(H).forEach(n=>{delete H[n]})}var Ai="e02003d";var ce=null,Oo=null,Pi=null,Mi=null;var Pn=0,_i=0,Mn=0;function Vi(n,e={}){if(ce)return ce;Mi=n||null,n&&"world"in n&&Jt(n);let t=e.position||"top-right";ce=document.createElement("div"),ce.id="modu-debug-ui",ce.style.cssText=`
        position: fixed;
        ${t.includes("top")?"top: 10px":"bottom: 10px"};
        ${t.includes("right")?"right: 10px":"left: 10px"};
        background: rgba(0, 0, 0, 0.8);
        color: #0f0;
        font: 12px monospace;
        padding: 8px 12px;
        border-radius: 4px;
        z-index: 10000;
        min-width: 180px;
        user-select: text;
        cursor: text;
        
    `,document.body.appendChild(ce);let i=r=>{if(!ce)return;Pn++,r-Mn>=1e3&&(_i=Pn,Pn=0,Mn=r);let s=Mi;if(!s){ce.innerHTML='<div style="color:#f00">No engine instance</div>';return}let a=s.getClientId(),c=s.getFrame(),l=s.getNodeUrl(),d=s.getLastSnapshot(),u=s.getServerFps(),h=s.getRoomId(),m=s.getUploadRate(),f=s.getDownloadRate(),y=s.getClients(),x="--------";try{if(Pi){let z=Pi();x=typeof z=="number"?z.toString(16).padStart(8,"0"):String(z).slice(0,8)}else x=s.getStateHash().toString(16).padStart(8,"0")}catch{x="error"}let v=z=>z>=1024?(z/1024).toFixed(1)+" kB/s":Math.round(z)+" B/s",C=v(m),E=v(f),A=s.getDeltaBandwidth?.()||0,D=s.getDriftStats?.()||{determinismPercent:100,totalChecks:0,matchingFieldCount:0,totalFieldCount:0},R=(Math.floor(D.determinismPercent*10)/10).toFixed(1),O=D.determinismPercent===100?"#0f0":D.determinismPercent>=99?"#ff0":"#f00",L;D.totalChecks>0?L=`<span style="color:${O}">${R}%</span> <span style="color:#888">(${D.matchingFieldCount}/${D.totalFieldCount})</span>`:A>0?L='<span style="color:#0f0">active</span>':L='<span style="color:#888">-</span>';let q=d.frame?c-d.frame:0,X=d.hash!==null?d.hash.toString(16).padStart(8,"0"):null,Fe=X?`${X} <span style="color:#888">(${q} ago)</span>`:"none",T=z=>z>=1024*1024?(z/(1024*1024)).toFixed(2)+" MB":z>=1024?(z/1024).toFixed(1)+" KB":z+" B",V=d.size>0?T(d.size):"-",U=s.getEntityCount?.()||0,Q=U>0?String(U):"-",te="color:#666;font-size:10px;margin-top:6px;margin-bottom:2px;border-bottom:1px solid #333;",Ce=v(A);ce.innerHTML=`
            <div style="${te}">ROOM</div>
            <div>ID: <span style="color:#fff">${h||"-"}</span></div>
            <div>Players: <span style="color:#ff0">${y.length}</span></div>
            <div>Frame: <span style="color:#fff">${c}</span></div>

            <div style="${te}">CLIENT</div>
            <div>ID: <span style="color:#ff0">${a?a.slice(0,8):"-"}</span></div>

            <div style="${te}">ENGINE</div>
            <div>Commit: <span style="color:#888">${Ai}</span></div>
            <div>FPS: <span style="color:#0f0">${_i}</span> render, <span style="color:#0f0">${u}</span> tick</div>
            <div>Net: <span style="color:#0f0">${C}</span> up, <span style="color:#f80">${E}</span> down</div>

            <div style="${te}">STATE SYNC</div>
            <div>Hash: <span style="color:#f0f">${x}</span></div>
            <div>Delta: <span style="color:#0ff">${Ce}</span></div>
            <div>Sync: ${L}</div>
            <div>Entities: <span style="color:#fff">${Q}</span></div>
        `},o=r=>{i(r),Oo=requestAnimationFrame(o)};return Mn=performance.now(),requestAnimationFrame(o),ce}var Ln={};Dt(Ln,{BodyType2D:()=>We,DEFAULT_FILTER:()=>on,Layers:()=>Xe,QuadTree2D:()=>fn,Shape2DType:()=>Me,SpatialHash2D:()=>je,TriggerState:()=>yn,aabb2DArea:()=>ki,aabb2DOverlap:()=>en,aabb2DUnion:()=>Ni,addBody2D:()=>hn,applyForce2D:()=>Wi,applyImpulse2D:()=>Nn,computeAABB2D:()=>_e,createBody2D:()=>Ge,createBox2D:()=>Li,createBox2DFromSize:()=>nn,createCircle:()=>tn,createFilter:()=>zi,createWorld2D:()=>pn,detectCollision2D:()=>dn,filterCollidingWith:()=>Oi,filterExcluding:()=>Yi,getBody2DIdCounter:()=>gt,loadWorldState2D:()=>Zi,makeTrigger:()=>Qi,removeBody2D:()=>Ke,resetBody2DIdCounter:()=>ln,resolveCollision2D:()=>un,saveWorldState2D:()=>Ki,setBody2DIdCounter:()=>xt,setBody2DMass:()=>qi,setBody2DVelocity:()=>Xi,shouldCollide:()=>rn,stepWorld2D:()=>St,vec2:()=>sn,vec2Add:()=>$e,vec2Clone:()=>Ui,vec2Cross:()=>Vn,vec2Dot:()=>Hi,vec2LengthSq:()=>an,vec2Scale:()=>ve,vec2Sub:()=>_n,vec2Zero:()=>yt});var Me=(t=>(t[t.Circle=0]="Circle",t[t.Box=1]="Box",t))(Me||{});function en(n,e){return n.minX<=e.maxX&&n.maxX>=e.minX&&n.minY<=e.maxY&&n.maxY>=e.minY}function Ni(n,e){return{minX:oe(n.minX,e.minX),minY:oe(n.minY,e.minY),maxX:le(n.maxX,e.maxX),maxY:le(n.maxY,e.maxY)}}function ki(n){let e=n.maxX-n.minX,t=n.maxY-n.minY;return p(e,t)}function tn(n){return{type:0,radius:g(n)}}function Li(n,e){return{type:1,halfWidth:g(n),halfHeight:g(e)}}function nn(n,e){let t=g(n)>>1,i=g(e)>>1;return{type:1,halfWidth:t,halfHeight:i}}var Xe={NONE:0,DEFAULT:1,PLAYER:2,ENEMY:4,PROJECTILE:8,ITEM:16,TRIGGER:32,WORLD:64,PROP:128,CUSTOM_1:256,CUSTOM_2:512,CUSTOM_3:1024,CUSTOM_4:2048,CUSTOM_5:4096,CUSTOM_6:8192,CUSTOM_7:16384,CUSTOM_8:32768,ALL:65535},on={layer:Xe.DEFAULT,mask:Xe.ALL};function zi(n,e=Xe.ALL){return{layer:n,mask:e}}function rn(n,e){return(n.mask&e.layer)!==0&&(e.mask&n.layer)!==0}function Oi(n,...e){let t=0;for(let i of e)t|=i;return{layer:n,mask:t}}function Yi(n,...e){let t=Xe.ALL;for(let i of e)t&=~i;return{layer:n,mask:t}}var Yo=g(0),Uo=g(.5),Ho=5461,We=(i=>(i[i.Static=0]="Static",i[i.Kinematic=1]="Kinematic",i[i.Dynamic=2]="Dynamic",i))(We||{});function yt(){return{x:0,y:0}}function sn(n,e){return{x:g(n),y:g(e)}}function Ui(n){return{x:n.x,y:n.y}}function $e(n,e){return{x:n.x+e.x,y:n.y+e.y}}function _n(n,e){return{x:n.x-e.x,y:n.y-e.y}}function ve(n,e){return{x:p(n.x,e),y:p(n.y,e)}}function Hi(n,e){return p(n.x,e.x)+p(n.y,e.y)}function an(n){return p(n.x,n.x)+p(n.y,n.y)}function Vn(n,e){return p(n.x,e.y)-p(n.y,e.x)}var cn=1;function ln(){cn=1}function gt(){return cn}function xt(n){cn=n}function Ge(n,e,t,i,o){let r=n===2?g(1):0,s=n===2?65536:0,a=0;if(n===2)if(e.type===0){let d=e.radius;a=p(p(r,32768),p(d,d))}else{let d=e.halfWidth<<1,u=e.halfHeight<<1;a=p(p(r,Ho),p(d,d)+p(u,u))}let c=cn++,l=o||"body2d_"+c;return{id:c,type:n,shape:e,label:l,position:sn(t,i),angle:0,linearVelocity:yt(),angularVelocity:0,mass:r,invMass:s,inertia:a||65536,invInertia:a?b(65536,a):0,restitution:Yo,friction:Uo,isSleeping:!1,sleepFrames:0,lockRotation:!1,isSensor:!1,isBullet:!1,filter:{...on},userData:null}}function qi(n,e){n.type===2&&(n.mass=g(e),n.invMass=e>0?b(65536,n.mass):0)}function Xi(n,e,t){n.linearVelocity=sn(e,t),n.isSleeping=!1}function Nn(n,e,t){if(!(n.type!==2||n.invMass===0)){if(n.linearVelocity=$e(n.linearVelocity,ve(e,n.invMass)),t&&!n.lockRotation){let i=_n(t,n.position),o=Vn(i,e);n.angularVelocity=n.angularVelocity+p(o,n.invInertia)}n.isSleeping=!1}}function Wi(n,e,t){if(n.type!==2||n.invMass===0)return;let i=ve(e,t);Nn(n,i)}function _e(n){let{position:e,shape:t,angle:i}=n;if(t.type===0){let o=t.radius;return{minX:e.x-o,minY:e.y-o,maxX:e.x+o,maxY:e.y+o}}else{let o=t,r=o.halfWidth,s=o.halfHeight;if(i===0)return{minX:e.x-r,minY:e.y-s,maxX:e.x+r,maxY:e.y+s};let a=De(i),c=fe(i),l=F(a),d=F(c),u=p(r,l)+p(s,d),h=p(r,d)+p(s,l);return{minX:e.x-u,minY:e.y-h,maxX:e.x+u,maxY:e.y+h}}}function dn(n,e){let t=n.shape,i=e.shape;if(t.type===0&&i.type===0)return qo(n,e);if(t.type===1&&i.type===1)return Xo(n,e);if(t.type===0&&i.type===1)return $i(n,e);if(t.type===1&&i.type===0){let o=$i(e,n);return o?{bodyA:n,bodyB:e,point:o.point,normal:{x:-o.normal.x,y:-o.normal.y},depth:o.depth}:null}return null}function qo(n,e){let t=n.shape.radius,i=e.shape.radius,o=t+i,r=e.position.x-n.position.x,s=e.position.y-n.position.y,a=p(r,r)+p(s,s),c=p(o,o);if(a>=c)return null;let l=M(a),d=o-l,u,h;if(l>0){let y=b(65536,l);u=p(r,y),h=p(s,y)}else u=65536,h=0;let m=n.position.x+p(u,t),f=n.position.y+p(h,t);return{bodyA:n,bodyB:e,point:{x:m,y:f},normal:{x:u,y:h},depth:d}}function Xo(n,e){let t=n.shape,i=e.shape,o=e.position.x-n.position.x,r=e.position.y-n.position.y,s=t.halfWidth+i.halfWidth-F(o),a=t.halfHeight+i.halfHeight-F(r);if(s<=0||a<=0)return null;let c,l,d;s<a?(d=s,c=o>0?65536:-65536,l=0):(d=a,c=0,l=r>0?65536:-65536);let u=n.position.x+e.position.x>>1,h=n.position.y+e.position.y>>1;return{bodyA:n,bodyB:e,point:{x:u,y:h},normal:{x:c,y:l},depth:d}}function $i(n,e){let t=n.shape.radius,i=e.shape,o=n.position.x-e.position.x,r=n.position.y-e.position.y,s=le(-i.halfWidth,oe(i.halfWidth,o)),a=le(-i.halfHeight,oe(i.halfHeight,r)),c=F(o)<i.halfWidth&&F(r)<i.halfHeight,l,d,u;if(c){let f=i.halfWidth-o,y=i.halfWidth+o,x=i.halfHeight-r,v=i.halfHeight+r,C=f;l=65536,d=0,y<C&&(C=y,l=-65536,d=0),x<C&&(C=x,l=0,d=65536),v<C&&(C=v,l=0,d=-65536),u=C+t}else{let f=o-s,y=r-a,x=p(f,f)+p(y,y);if(x>=p(t,t))return null;let v=M(x);if(u=t-v,v>0){let C=b(65536,v);l=p(-f,C),d=p(-y,C)}else l=65536,d=0}let h=n.position.x+p(l,t),m=n.position.y+p(d,t);return{bodyA:n,bodyB:e,point:{x:h,y:m},normal:{x:l,y:d},depth:u}}function un(n){let{bodyA:e,bodyB:t,normal:i,depth:o}=n;if(e.isSensor||t.isSensor)return;let r=e.type,s=t.type;r===0&&s===0||(Wo(e,t,i,o),(r===2||s===2)&&$o(e,t,i))}function Wo(n,e,t,i){let o=n.type,r=e.type,s=o!==0,a=r!==0;if(!s&&!a)return;let c=g(.01),l=le(0,i-c);if(!(l<=0))if(s&&a){let d=l>>1;n.position.x=n.position.x-p(t.x,d),n.position.y=n.position.y-p(t.y,d),e.position.x=e.position.x+p(t.x,d),e.position.y=e.position.y+p(t.y,d)}else s?(n.position.x=n.position.x-p(t.x,l),n.position.y=n.position.y-p(t.y,l)):(e.position.x=e.position.x+p(t.x,l),e.position.y=e.position.y+p(t.y,l))}function $o(n,e,t){let i=n.type===2?n.invMass:0,o=e.type===2?e.invMass:0,r=i+o;if(r===0)return;let s=e.linearVelocity.x-n.linearVelocity.x,a=e.linearVelocity.y-n.linearVelocity.y,c=p(s,t.x)+p(a,t.y);if(c>0)return;let l=oe(n.restitution,e.restitution),d=b(p(-(65536+l),c),r),u=p(t.x,d),h=p(t.y,d);n.type===2&&(n.linearVelocity.x=n.linearVelocity.x-p(u,i),n.linearVelocity.y=n.linearVelocity.y-p(h,i)),e.type===2&&(e.linearVelocity.x=e.linearVelocity.x+p(u,o),e.linearVelocity.y=e.linearVelocity.y+p(h,o)),Go(n,e,t,d,i,o,r)}function Go(n,e,t,i,o,r,s){let a=e.linearVelocity.x-n.linearVelocity.x,c=e.linearVelocity.y-n.linearVelocity.y,l=p(a,t.x)+p(c,t.y),d=a-p(t.x,l),u=c-p(t.y,l),h=p(d,d)+p(u,u);if(h===0)return;let m=M(h),f=b(65536,m),y=p(d,f),x=p(u,f),v=p(n.friction,e.friction),C=p(a,y)+p(c,x),E=b(-C,s),A=p(v,F(i));F(E)>A&&(E=E>0?A:-A);let D=p(y,E),R=p(x,E);n.type===2&&(n.linearVelocity.x=n.linearVelocity.x-p(D,o),n.linearVelocity.y=n.linearVelocity.y-p(R,o)),e.type===2&&(e.linearVelocity.x=e.linearVelocity.x+p(D,r),e.linearVelocity.y=e.linearVelocity.y+p(R,r))}function jo(n){if(n.shape.type===0)return w(n.shape.radius);{let e=n.shape,t=w(e.halfWidth),i=w(e.halfHeight);return Math.sqrt(t*t+i*i)}}var je=class{constructor(e=64){this.cells=new Map;this.bodyToCell=new Map;this.oversized=[];this.allRegular=[];this.cellSize=e,this.invCellSize=1/e}hashPosition(e,t){let i=Math.floor(e*this.invCellSize)&65535,o=Math.floor(t*this.invCellSize)&65535;return i<<16|o}clear(){this.cells.clear(),this.bodyToCell.clear(),this.oversized.length=0,this.allRegular.length=0}insert(e){if(jo(e)*2>this.cellSize){this.oversized.push(e);return}this.allRegular.push(e);let o=w(e.position.x),r=w(e.position.y),s=this.hashPosition(o,r),a=this.cells.get(s);a||(a=[],this.cells.set(s,a)),a.push(e),this.bodyToCell.set(e,s)}insertAll(e){for(let t of e)this.insert(t)}queryPoint(e,t){let i=this.hashPosition(e,t);return this.cells.get(i)||[]}queryNearby(e){let t=w(e.position.x),i=w(e.position.y),o=Math.floor(t*this.invCellSize),r=Math.floor(i*this.invCellSize),s=[];for(let a=-1;a<=1;a++)for(let c=-1;c<=1;c++){let l=o+a&65535,d=r+c&65535,u=l<<16|d,h=this.cells.get(u);if(h)for(let m of h)m!==e&&s.push(m)}return s}queryRadius(e,t,i){let o=Math.ceil(i*this.invCellSize),r=Math.floor(e*this.invCellSize),s=Math.floor(t*this.invCellSize),a=[],c=new Set;for(let l=-o;l<=o;l++)for(let d=-o;d<=o;d++){let u=r+l&65535,h=s+d&65535,m=u<<16|h,f=this.cells.get(m);if(f)for(let y of f)c.has(y)||(c.add(y),a.push(y))}return a}forEachPair(e){for(let[o,r]of this.cells){for(let u=0;u<r.length;u++)for(let h=u+1;h<r.length;h++)e(r[u],r[h]);let s=o>>16&65535,a=o&65535,c=[(s+1&65535)<<16|a,s<<16|a+1&65535,(s+1&65535)<<16|a+1&65535];for(let u of c){if(u<=o)continue;let h=this.cells.get(u);if(h)for(let m of r)for(let f of h)e(m,f)}let l=(s-1&65535)<<16|a+1&65535,d=this.cells.get(l);if(d)for(let u of r)for(let h of d)e(u,h)}let t=this.oversized,i=this.allRegular;for(let o=0;o<t.length;o++)for(let r=o+1;r<t.length;r++)e(t[o],t[r]);for(let o of t)for(let r of i)e(o,r)}getPotentialPairs(){let e=[];return this.forEachPair((t,i)=>e.push([t,i])),e}getStats(){let e=0,t=0;for(let i of this.cells.values())e=Math.max(e,i.length),t+=i.length;return{cellCount:this.cells.size,maxPerCell:e,avgPerCell:this.cells.size>0?t/this.cells.size:0,oversizedCount:this.oversized.length}}};var Gi={x:0,y:g(-30)},Ko=g(.1),Zo=g(.1),ji=g(.12),Qo=20,Jo=64;function pn(n=1/60){let e={bodies:[],gravity:{x:Gi.x,y:Gi.y},dt:g(n),step(){St(e)}};return e}function hn(n,e){n.bodies.push(e)}function Ke(n,e){let t=n.bodies.indexOf(e);t>=0&&n.bodies.splice(t,1)}function St(n){let{gravity:e,dt:t}=n,i=[],o=[],r=[],s=[...n.bodies].sort((c,l)=>c.label.localeCompare(l.label));for(let c of s){if(c.type!==2||c.isSleeping)continue;c.linearVelocity=$e(c.linearVelocity,ve(e,t));let l=65536-Ko,d=65536-Zo;c.linearVelocity=ve(c.linearVelocity,l),c.angularVelocity=p(c.angularVelocity,d)}let a=new je(Jo);a.insertAll(s),a.forEachPair((c,l)=>{if(c.type===0&&l.type===0||!rn(c.filter,l.filter))return;let d=_e(c),u=_e(l);if(!en(d,u))return;let h=dn(c,l);if(!h)return;let m=c.userData,f=l.userData;if((m||f)&&r.push({entityA:m,entityB:f,labelA:c.label,labelB:l.label}),c.isSensor||l.isSensor){c.isSensor&&o.push({trigger:c,other:l}),l.isSensor&&o.push({trigger:l,other:c});return}i.push(h),n.contactListener&&n.contactListener.onContact(c,l),un(h)}),r.sort((c,l)=>{let d=c.labelA.localeCompare(l.labelA);return d!==0?d:c.labelB.localeCompare(l.labelB)});for(let c of r)c.entityA?.active===!1||c.entityB?.active===!1||n.physics2d?.handleCollision?.(c.entityA,c.entityB)||(c.entityA?.onCollision&&c.entityA.onCollision(c.entityB),c.entityB?.onCollision&&c.entityB.onCollision(c.entityA));for(let c of s){if(c.type===0||c.isSleeping)continue;let l=g(.05),d=g(.01);F(c.linearVelocity.x)<l&&(c.linearVelocity.x=0),F(c.linearVelocity.y)<l&&(c.linearVelocity.y=0),F(c.angularVelocity)<d&&(c.angularVelocity=0),c.position=$e(c.position,ve(c.linearVelocity,t)),!c.lockRotation&&c.angularVelocity!==0&&(c.angle=c.angle+p(c.angularVelocity,t));let u=an(c.linearVelocity),h=p(c.angularVelocity,c.angularVelocity),m=p(ji,ji);u<m&&h<m?(c.sleepFrames++,c.sleepFrames>=Qo&&(c.isSleeping=!0,c.linearVelocity=yt(),c.angularVelocity=0)):(c.sleepFrames=0,c.isSleeping=!1)}return{contacts:i,triggers:o}}function er(n){if(n.type===0)return{type:0,radius:n.radius};{let e=n;return{type:1,halfWidth:e.halfWidth,halfHeight:e.halfHeight}}}function tr(n){return n.type===0?{type:0,radius:n.radius}:{type:1,halfWidth:n.halfWidth,halfHeight:n.halfHeight}}function nr(n){return{id:n.id,label:n.label,bodyType:n.type,shape:er(n.shape),px:n.position.x,py:n.position.y,angle:n.angle,vx:n.linearVelocity.x,vy:n.linearVelocity.y,av:n.angularVelocity,mass:n.mass,restitution:n.restitution,friction:n.friction,isSleeping:n.isSleeping,sleepFrames:n.sleepFrames,lockRotation:n.lockRotation,isSensor:n.isSensor,isBullet:n.isBullet,filter:{...n.filter},userData:n.userData}}function Ki(n){return{bodies:n.bodies.map(nr)}}function ir(n){let e=tr(n.shape),t=gt(),i=Ge(n.bodyType,e,0,0,n.label);if(i.id=n.id,xt(t),i.position={x:n.px,y:n.py},i.angle=n.angle,i.linearVelocity={x:n.vx,y:n.vy},i.angularVelocity=n.av,i.mass=n.mass,i.invMass=n.mass>0?b(65536,n.mass):0,n.bodyType===2&&n.mass>0){if(e.type===0){let o=e.radius;i.inertia=p(p(n.mass,32768),p(o,o))}else{let o=e,r=o.halfWidth<<1,s=o.halfHeight<<1,a=5461;i.inertia=p(p(n.mass,a),p(r,r)+p(s,s))}i.invInertia=i.inertia>0?b(65536,i.inertia):0}return i.restitution=n.restitution,i.friction=n.friction,i.isSleeping=n.isSleeping,i.sleepFrames=n.sleepFrames,i.lockRotation=n.lockRotation,i.isSensor=n.isSensor,i.isBullet=n.isBullet??!1,i.filter={...n.filter},i.userData=n.userData,i}function Zi(n,e){let t=[...e.bodies].sort((a,c)=>a.label.localeCompare(c.label)),i=new Set(t.map(a=>a.label));for(let a=n.bodies.length-1;a>=0;a--)i.has(n.bodies[a].label)||n.bodies.splice(a,1);let o=new Map(n.bodies.map(a=>[a.label,a])),r=0;for(let a of t){a.id>r&&(r=a.id);let c=o.get(a.label);if(c)c.position={x:a.px,y:a.py},c.angle=a.angle,c.linearVelocity={x:a.vx,y:a.vy},c.angularVelocity=a.av,c.isSleeping=a.isSleeping,c.sleepFrames=a.sleepFrames,c.lockRotation=a.lockRotation,c.isSensor=a.isSensor,c.restitution=a.restitution,c.friction=a.friction,c.filter={...a.filter},a.userData!==void 0&&(c.userData=a.userData);else{let l=ir(a);n.bodies.push(l)}}let s=gt();r>=s&&xt(r+1),n.bodies.sort((a,c)=>a.label.localeCompare(c.label))}var or=8,rr=8;function sr(n,e){return n.minX<=e.maxX&&n.maxX>=e.minX&&n.minY<=e.maxY&&n.maxY>=e.minY}function mn(n){let e=_e(n);return{minX:w(e.minX),minY:w(e.minY),maxX:w(e.maxX),maxY:w(e.maxY)}}var kn=class n{constructor(e,t,i,o){this.entities=[];this.children=null;this.bounds=e,this.depth=t,this.maxEntities=i,this.maxDepth=o}insert(e,t){if(this.children){let i=this.getChildIndex(t);if(i!==-1){this.children[i].insert(e,t);return}this.entities.push(e);return}this.entities.push(e),this.entities.length>this.maxEntities&&this.depth<this.maxDepth&&this.subdivide()}subdivide(){let{minX:e,minY:t,maxX:i,maxY:o}=this.bounds,r=(e+i)/2,s=(t+o)/2;this.children=[new n({minX:e,minY:t,maxX:r,maxY:s},this.depth+1,this.maxEntities,this.maxDepth),new n({minX:r,minY:t,maxX:i,maxY:s},this.depth+1,this.maxEntities,this.maxDepth),new n({minX:e,minY:s,maxX:r,maxY:o},this.depth+1,this.maxEntities,this.maxDepth),new n({minX:r,minY:s,maxX:i,maxY:o},this.depth+1,this.maxEntities,this.maxDepth)];let a=this.entities;this.entities=[];for(let c of a){let l=mn(c),d=this.getChildIndex(l);d!==-1?this.children[d].insert(c,l):this.entities.push(c)}}getChildIndex(e){let{minX:t,minY:i,maxX:o,maxY:r}=this.bounds,s=(t+o)/2,a=(i+r)/2,c=e.maxY<=a,l=e.minY>=a,d=e.maxX<=s,u=e.minX>=s;return c&&d?0:c&&u?1:l&&d?2:l&&u?3:-1}query(e,t){for(let i of this.entities)t.push(i);if(this.children)for(let i of this.children)sr(i.bounds,e)&&i.query(e,t)}forEachPairIterative(e){let t=[],i=[];for(t.push({node:this,ancestorStart:0});t.length>0;){let{node:o,ancestorStart:r}=t.pop();i.length=r;let s=o.entities;for(let c=0;c<s.length;c++)for(let l=c+1;l<s.length;l++)e(s[c],s[l]);for(let c=0;c<r;c++)for(let l of s)e(i[c],l);let a=i.length;for(let c of s)i.push(c);if(o.children)for(let c=3;c>=0;c--)t.push({node:o.children[c],ancestorStart:i.length})}}forEachPair(e,t=[]){this.forEachPairIterative(e)}getStats(){let e=1,t=this.depth,i=this.entities.length;if(this.children)for(let o of this.children){let r=o.getStats();e+=r.nodeCount,t=Math.max(t,r.maxDepth),i+=r.entityCount}return{nodeCount:e,maxDepth:t,entityCount:i}}},fn=class{constructor(e=or,t=rr){this.root=null;this.maxEntities=e,this.maxDepth=t}clear(){this.root=null}insertAll(e){if(e.length===0)return;let t=1/0,i=1/0,o=-1/0,r=-1/0;for(let a of e){let c=mn(a);t=Math.min(t,c.minX),i=Math.min(i,c.minY),o=Math.max(o,c.maxX),r=Math.max(r,c.maxY)}let s=1;this.root=new kn({minX:t-s,minY:i-s,maxX:o+s,maxY:r+s},0,this.maxEntities,this.maxDepth);for(let a of e){let c=mn(a);this.root.insert(a,c)}}queryNearby(e){if(!this.root)return[];let t=[],i=mn(e);return this.root.query(i,t),t.filter(o=>o!==e)}forEachPair(e){this.root&&this.root.forEachPair(e)}getStats(){return this.root?this.root.getStats():{nodeCount:0,maxDepth:0,entityCount:0}}};var yn=class{constructor(){this.overlaps=new Map;this.enterCallbacks=[];this.stayCallbacks=[];this.exitCallbacks=[];this.pendingPairs=[]}onEnter(e){this.enterCallbacks.push(e)}onStay(e){this.stayCallbacks.push(e)}onExit(e){this.exitCallbacks.push(e)}processOverlaps(e){let t=new Set,i=[...e].sort((r,s)=>this.makeKey(r.trigger,r.other).localeCompare(this.makeKey(s.trigger,s.other)));for(let r of i){let s=this.makeKey(r.trigger,r.other);if(t.add(s),this.overlaps.has(s))for(let a of this.stayCallbacks)a(r);else{this.overlaps.set(s,r);for(let a of this.enterCallbacks)a(r)}}let o=[...this.overlaps.keys()].sort();for(let r of o)if(!t.has(r)){let s=this.overlaps.get(r);this.overlaps.delete(r);for(let a of this.exitCallbacks)a(s)}}clear(){this.overlaps.clear()}removeBody(e){let t=[];for(let[i,o]of this.overlaps)(o.trigger===e||o.other===e)&&t.push(i);t.sort();for(let i of t){let o=this.overlaps.get(i);this.overlaps.delete(i);for(let r of this.exitCallbacks)r(o)}}getOverlappingBodies(e){let t=[];for(let i of this.overlaps.values())i.trigger===e&&t.push(i.other);return t.sort((i,o)=>i.label.localeCompare(o.label))}isBodyInTrigger(e,t){return this.overlaps.has(this.makeKey(e,t))}overlapCount(){return this.overlaps.size}saveState(){let e=[];for(let t of this.overlaps.values())e.push([t.trigger.label,t.other.label]);return e.sort((t,i)=>t[0].localeCompare(i[0])||t[1].localeCompare(i[1]))}loadState(e){this.overlaps.clear(),this.pendingPairs=e}syncWithWorld(e){let t=new Map;for(let i of e)t.set(i.label,i);for(let[i,o]of this.pendingPairs){let r=t.get(i),s=t.get(o);r&&s&&this.overlaps.set(this.makeKey(r,s),{trigger:r,other:s})}this.pendingPairs=[]}makeKey(e,t){return`${e.label}:${t.label}`}};function Qi(n){return n.isSensor=!0,n}var vt=class{constructor(e,t){this.world=null;this.entityToBody=new Map;this.bodyToEntity=new Map;this.collisionHandlers=new Map;this.pendingEntities=new Set;let i,o=null;e&&"world"in e?(o=e,i=t??{}):i=e??{},this.physicsWorld=pn(i.dt??1/60),i.gravity&&(this.physicsWorld.gravity={x:g(i.gravity.x),y:g(i.gravity.y)});let r=this;this.physicsWorld.contactListener={onContact(s,a){r.handleCollision(s,a)}},this.physicsWorld.physics2d={handleCollision:(s,a)=>this.handleCollisionByType(s,a)},o&&(this.attach(o.world),o.physics=this)}attach(e){return this.world=e,e.addSystem(()=>this.syncBodiesToPhysics(),{phase:"prePhysics",order:0}),e.addSystem(()=>this.step(),{phase:"physics",order:0}),e.addSystem(()=>this.syncPhysicsToComponents(),{phase:"postPhysics",order:0}),this}onCollision(e,t,i){let o=`${e}:${t}`,r=`${t}:${e}`;return this.collisionHandlers.set(o,i),e!==t&&this.collisionHandlers.set(r,(s,a)=>i(a,s)),this}setGravity(e,t){return this.physicsWorld.gravity={x:g(e),y:g(t)},this}ensureBody(e){let t=e.eid,i=this.entityToBody.get(t);if(i)return i;if(!e.has(W)||!e.has(K))return null;let o=e.get(W),r=e.get(K),s;switch(r.bodyType){case st:s=0;break;case at:s=1;break;default:s=2}let a;return r.shapeType===Oe||r.radius>0?a=tn(r.radius||10):a=nn(r.width||10,r.height||10),i=Ge(s,a,o.x,o.y),i.angle=g(o.angle),i.linearVelocity={x:g(r.vx),y:g(r.vy)},i.isSensor=r.isSensor,i.isSleeping=!1,i.sleepFrames=0,i.userData=e,i.label=t.toString(),hn(this.physicsWorld,i),this.entityToBody.set(t,i),this.bodyToEntity.set(i.id,t),i}removeBody(e){let t=e.eid,i=this.entityToBody.get(t);i&&(Ke(this.physicsWorld,i),this.entityToBody.delete(t),this.bodyToEntity.delete(i.id))}syncBodiesToPhysics(){if(this.world){for(let e of this.world.query(K)){let t=this.ensureBody(e);if(!t)continue;let i=e.get(K);if(i.bodyType===at||i.bodyType===st){let s=e.get(W);t.position.x=g(s.x),t.position.y=g(s.y),t.angle=g(s.angle)}if((i.impulseX!==0||i.impulseY!==0)&&(i.vx+=i.impulseX,i.vy+=i.impulseY,i.impulseX=0,i.impulseY=0),(i.forceX!==0||i.forceY!==0)&&(i.vx+=i.forceX,i.vy+=i.forceY,i.forceX=0,i.forceY=0),i.damping>0){let s=1-i.damping;i.vx*=s,i.vy*=s}let o=g(i.vx),r=g(i.vy);if(t.linearVelocity.x=o,t.linearVelocity.y=r,(o!==0||r!==0)&&(t.isSleeping=!1,t.sleepFrames=0),t.shape.type===0){let s=t.shape.radius,a=g(i.radius);s!==a&&(t.shape.radius=a)}}for(let[e,t]of this.entityToBody)this.world.isDestroyed(e)&&(Ke(this.physicsWorld,t),this.entityToBody.delete(e),this.bodyToEntity.delete(t.id))}}step(){St(this.physicsWorld)}syncPhysicsToComponents(){for(let[e,t]of this.entityToBody){let i=this.world?.getEntity(e);if(!i||i.destroyed)continue;let o=i.get(W),r=i.get(K);o.x=w(t.position.x),o.y=w(t.position.y),o.angle=w(t.angle),r.vx=w(t.linearVelocity.x),r.vy=w(t.linearVelocity.y)}}handleCollision(e,t){let i=e.userData,o=t.userData;!i||!o||i.destroyed||o.destroyed||this.handleCollisionByType(i,o)}handleCollisionByType(e,t){if(!e||!t||e.destroyed||t.destroyed)return!1;let i=`${e.type}:${t.type}`,o=this.collisionHandlers.get(i);return o?(o(e,t),e.type===t.type&&!e.destroyed&&!t.destroyed&&o(t,e),!0):!1}getBody(e){return this.entityToBody.get(e.eid)}getEntityForBody(e){let t=this.bodyToEntity.get(e.id);return t===void 0?null:this.world?.getEntity(t)??null}clear(){for(let e of this.entityToBody.values())Ke(this.physicsWorld,e);this.entityToBody.clear(),this.bodyToEntity.clear(),ln()}wakeAllBodies(){for(let e of this.physicsWorld.bodies)e.isSleeping=!1,e.sleepFrames=0}};function Ji(n={}){return new vt(n)}var On={};Dt(On,{BodyType:()=>xn,DEFAULT_FILTER:()=>gn,Layers:()=>Qe,ShapeType:()=>Ze,TriggerState:()=>Je,aabbOverlap:()=>bt,addBody:()=>go,applyForce:()=>po,applyImpulse:()=>be,computeAABB:()=>Ve,createBody:()=>co,createBox:()=>eo,createFilter:()=>no,createSphere:()=>to,createWorld:()=>yo,detectCollision:()=>Ne,filterCollidingWith:()=>io,filterExcluding:()=>oo,getBodyIdCounter:()=>so,isGrounded:()=>So,loadWorldState:()=>Fo,makeTrigger:()=>fo,raycast:()=>vo,removeBody:()=>xo,resetBodyIdCounter:()=>ro,resolveCollision:()=>vn,saveWorldState:()=>bo,setBodyIdCounter:()=>ao,setBodyMass:()=>lo,setBodyVelocity:()=>uo,shouldCollide:()=>Ft,stepWorld:()=>zn});var Ze=(t=>(t[t.Box=0]="Box",t[t.Sphere=1]="Sphere",t))(Ze||{});function eo(n,e,t){return{type:0,halfExtents:Te(n,e,t)}}function to(n){return{type:1,radius:g(n)}}function bt(n,e){return n.max.x>=e.min.x&&n.min.x<=e.max.x&&n.max.y>=e.min.y&&n.min.y<=e.max.y&&n.max.z>=e.min.z&&n.min.z<=e.max.z}var Qe={NONE:0,DEFAULT:1,PLAYER:2,ENEMY:4,PROJECTILE:8,ITEM:16,TRIGGER:32,WORLD:64,PROP:128,CUSTOM_1:256,CUSTOM_2:512,CUSTOM_3:1024,CUSTOM_4:2048,CUSTOM_5:4096,CUSTOM_6:8192,CUSTOM_7:16384,CUSTOM_8:32768,ALL:65535},gn={layer:Qe.DEFAULT,mask:Qe.ALL};function no(n,e=Qe.ALL){return{layer:n,mask:e}}function Ft(n,e){return(n.mask&e.layer)!==0&&(e.mask&n.layer)!==0}function io(n,...e){let t=0;for(let i of e)t|=i;return{layer:n,mask:t}}function oo(n,...e){let t=Qe.ALL;for(let i of e)t&=~i;return{layer:n,mask:t}}var ar=g(0),cr=g(.5),xn=(i=>(i[i.Static=0]="Static",i[i.Kinematic=1]="Kinematic",i[i.Dynamic=2]="Dynamic",i))(xn||{}),Ct=1;function ro(){Ct=1}function so(){return Ct}function ao(n){Ct=n}function co(n,e,t,i,o,r){let s=n===2?g(1):0,a=n===2?65536:0,c=0;if(n===2)if(e.type===0){let u=e.halfExtents;c=p(s,p(g(1/6),p(u.x,u.x)+p(u.y,u.y)+p(u.z,u.z)))}else{let u=e.radius;c=p(s,p(g(.4),p(u,u)))}let l=r||"body_"+Ct;return{id:Ct++,label:l,type:n,shape:e,position:Te(t,i,o),rotation:nt(),linearVelocity:de(),angularVelocity:de(),mass:s,invMass:a,inertia:c||65536,invInertia:c?b(65536,c):0,restitution:ar,friction:cr,isSleeping:!1,sleepFrames:0,lockRotationX:!1,lockRotationY:!1,lockRotationZ:!1,isTrigger:!1,filter:{...gn},userData:null}}function lo(n,e){n.type===2&&(n.mass=g(e),n.invMass=e>0?b(65536,n.mass):0)}function uo(n,e,t,i){n.linearVelocity=Te(e,t,i),n.isSleeping=!1}function be(n,e,t){if(!(n.type!==2||n.invMass===0)){if(n.linearVelocity=N(n.linearVelocity,B(e,n.invMass)),t){let i=_(t,n.position),o=j(i,e);n.angularVelocity=N(n.angularVelocity,B(o,n.invInertia))}n.isSleeping=!1}}function po(n,e,t){if(n.type!==2||n.invMass===0)return;let i=B(e,t);be(n,i)}var ho=g(.6),Sn=g(.05),lr=g(1.5);function Ve(n){let e=n.position,t=n.shape;if(t.type===1){let i=t.radius;return{min:{x:e.x-i,y:e.y-i,z:e.z-i},max:{x:e.x+i,y:e.y+i,z:e.z+i}}}else{let i=t.halfExtents,o=G(n.rotation,P(65536,0,0)),r=G(n.rotation,P(0,65536,0)),s=G(n.rotation,P(0,0,65536)),a=F(p(o.x,i.x))+F(p(r.x,i.y))+F(p(s.x,i.z)),c=F(p(o.y,i.x))+F(p(r.y,i.y))+F(p(s.y,i.z)),l=F(p(o.z,i.x))+F(p(r.z,i.y))+F(p(s.z,i.z));return{min:{x:e.x-a,y:e.y-c,z:e.z-l},max:{x:e.x+a,y:e.y+c,z:e.z+l}}}}function dr(n,e){let t=n.shape,i=e.shape,o=_(n.position,e.position),r=$(o),s=t.radius+i.radius,a=p(s,s);if(r>=a)return null;let c=M(r),l=c>0?B(o,b(65536,c)):P(65536,0,0),d=s-c,u=_(n.position,B(l,t.radius));return{bodyA:n,bodyB:e,normal:l,points:[{point:u,penetration:d}]}}function mo(n,e){let t=n.shape,i=e.shape,o=_(n.position,e.position),r=Vt(e.rotation),s=G(r,o),a=i.halfExtents,c={x:ke(s.x,-a.x,a.x),y:ke(s.y,-a.y,a.y),z:ke(s.z,-a.z,a.z)},l=_(s,c),d=$(l),u=p(t.radius,t.radius);if(d>=u)return null;let h=M(d),m,f;if(h>0)m=B(l,b(65536,h)),f=t.radius-h;else{let v=a.x-F(s.x),C=a.y-F(s.y),E=a.z-F(s.z);v<=C&&v<=E?(m=s.x>=0?P(65536,0,0):P(-65536,0,0),f=v+t.radius):C<=E?(m=s.y>=0?P(0,65536,0):P(0,-65536,0),f=C+t.radius):(m=s.z>=0?P(0,0,65536):P(0,0,-65536),f=E+t.radius)}let y=N(e.position,G(e.rotation,c)),x=G(e.rotation,m);return{bodyA:n,bodyB:e,normal:x,points:[{point:y,penetration:f}]}}function ur(n,e){let t=n.shape,i=e.shape,o=t.halfExtents,r=i.halfExtents,s=[G(n.rotation,P(65536,0,0)),G(n.rotation,P(0,65536,0)),G(n.rotation,P(0,0,65536))],a=[G(e.rotation,P(65536,0,0)),G(e.rotation,P(0,65536,0)),G(e.rotation,P(0,0,65536))],c=[o.x,o.y,o.z],l=[r.x,r.y,r.z],d=_(e.position,n.position),u=2147483647,h=P(0,65536,0);function m(T,V,U){return F(p(k(T[0],U),V[0]))+F(p(k(T[1],U),V[1]))+F(p(k(T[2],U),V[2]))}function f(T){let V=$(T);if(V<g(1e-4))return!0;let U=M(V),Q=B(T,b(65536,U)),te=m(s,c,Q),Ce=m(a,l,Q),z=F(k(d,Q)),Ee=te+Ce-z;return Ee<=0?!1:(Ee<u&&(u=Ee,h=k(d,Q)<0?Q:ye(Q)),!0)}for(let T=0;T<3;T++)if(!f(s[T])||!f(a[T]))return null;for(let T=0;T<3;T++)for(let V=0;V<3;V++)if(!f(j(s[T],a[V])))return null;let y=[],x=p(p(o.x,o.y),o.z),v=p(p(r.x,r.y),r.z),C=v<=x?e:n,E=v<=x?r:o,A=v<=x?n:e,D=[[-1,-1,-1],[-1,-1,1],[-1,1,-1],[-1,1,1],[1,-1,-1],[1,-1,1],[1,1,-1],[1,1,1]],R=v<=x?h:ye(h),O=[],L=v<=x?s:a,q=v<=x?o:r;for(let[T,V,U]of D){let Q=P(p(E.x,g(T)),p(E.y,g(V)),p(E.z,g(U))),te=N(C.position,G(C.rotation,Q)),Ce=_(te,A.position),z=k(Ce,R),Ee=p(F(k(L[0],R)),q.x)+p(F(k(L[1],R)),q.y)+p(F(k(L[2],R)),q.z),Et=z+Ee;Et>0&&O.push({point:te,depth:Et})}O.sort((T,V)=>{let U=V.depth-T.depth;return U!==0?U:T.point.x-V.point.x||T.point.y-V.point.y||T.point.z-V.point.z});let X=g(.05),Fe=O.length>0?O[0].depth:0;for(let T of O)if(T.depth>Fe-X&&y.push({point:T.point,penetration:T.depth}),y.length>=4)break;if(y.length===0){let T=B(N(n.position,e.position),32768);y.push({point:T,penetration:u})}return{bodyA:n,bodyB:e,normal:h,points:y}}function Ne(n,e){let t=n.shape.type,i=e.shape.type;if(t===1&&i===1)return dr(n,e);if(t===1&&i===0)return mo(n,e);if(t===0&&i===1){let o=mo(e,n);return o?{bodyA:n,bodyB:e,normal:ye(o.normal),points:o.points}:null}else return ur(n,e)}function vn(n){let{bodyA:e,bodyB:t,normal:i,points:o}=n;if(e.invMass===0&&t.invMass===0||o.length===0)return;let r=_(e.linearVelocity,t.linearVelocity);if(F(k(r,i))<lr&&(e.isSleeping||t.isSleeping)){for(let h of o){let m=h.penetration;if(m>Sn){let f=e.invMass+t.invMass;if(f>0){let y=p(b(m-Sn,f),ho),x=B(i,y);e.invMass>0&&!e.isSleeping&&(e.position=N(e.position,B(x,e.invMass))),t.invMass>0&&!t.isSleeping&&(t.position=_(t.position,B(x,t.invMass)))}}}return}let c=o.length,l=b(65536,g(c)),d=oe(e.restitution,t.restitution),u=b(e.friction+t.friction,g(2));for(let h of o){let m=h.point,f=h.penetration,y=_(m,e.position),x=_(m,t.position),v=N(e.linearVelocity,j(e.angularVelocity,y)),C=N(t.linearVelocity,j(t.angularVelocity,x)),E=_(v,C),A=k(E,i);if(A<0){let D=j(y,i),R=j(x,i),O=e.lockRotationX&&e.lockRotationY&&e.lockRotationZ?0:p(k(D,D),e.invInertia),L=t.lockRotationX&&t.lockRotationY&&t.lockRotationZ?0:p(k(R,R),t.invInertia),q=e.invMass+t.invMass+O+L,X=p(-(65536+d),A);X=b(X,q),X=p(X,l);let Fe=B(i,X);e.invMass>0&&be(e,Fe,m),t.invMass>0&&be(t,ye(Fe),m);let T=_(E,B(i,A)),V=$(T);if(V>g(1e-4)){let U=ue(T),Q=j(y,U),te=j(x,U),Ce=e.lockRotationX&&e.lockRotationY&&e.lockRotationZ?0:p(k(Q,Q),e.invInertia),z=t.lockRotationX&&t.lockRotationY&&t.lockRotationZ?0:p(k(te,te),t.invInertia),Ee=e.invMass+t.invMass+Ce+z,Et=M(V),tt=b(Et,Ee);tt=p(tt,l);let Yn=p(F(X),u);tt>Yn&&(tt=Yn);let Un=B(U,-tt);e.invMass>0&&be(e,Un,m),t.invMass>0&&be(t,ye(Un),m)}}if(f>Sn){let D=e.invMass+t.invMass,R=p(b(f-Sn,D),ho),O=p(R,l),L=B(i,O);e.invMass>0&&(e.position=N(e.position,B(L,e.invMass))),t.invMass>0&&(t.position=_(t.position,B(L,t.invMass)))}}}var Je=class{constructor(){this.overlaps=new Map;this.enterCallbacks=[];this.stayCallbacks=[];this.exitCallbacks=[];this.pendingPairs=[]}onEnter(e){this.enterCallbacks.push(e)}onStay(e){this.stayCallbacks.push(e)}onExit(e){this.exitCallbacks.push(e)}processOverlaps(e){let t=new Set,i=[...e].sort((r,s)=>this.makeKey(r.trigger,r.other).localeCompare(this.makeKey(s.trigger,s.other)));for(let r of i){let s=this.makeKey(r.trigger,r.other);if(t.add(s),this.overlaps.has(s))for(let a of this.stayCallbacks)a(r);else{this.overlaps.set(s,r);for(let a of this.enterCallbacks)a(r)}}let o=[...this.overlaps.keys()].sort();for(let r of o)if(!t.has(r)){let s=this.overlaps.get(r);this.overlaps.delete(r);for(let a of this.exitCallbacks)a(s)}}clear(){this.overlaps.clear()}removeBody(e){let t=[];for(let[i,o]of this.overlaps)(o.trigger===e||o.other===e)&&t.push(i);t.sort();for(let i of t){let o=this.overlaps.get(i);this.overlaps.delete(i);for(let r of this.exitCallbacks)r(o)}}getOverlappingBodies(e){let t=[];for(let i of this.overlaps.values())i.trigger===e&&t.push(i.other);return t.sort((i,o)=>i.label.localeCompare(o.label))}isBodyInTrigger(e,t){return this.overlaps.has(this.makeKey(e,t))}overlapCount(){return this.overlaps.size}saveState(){let e=[];for(let t of this.overlaps.values())e.push([t.trigger.label,t.other.label]);return e.sort((t,i)=>t[0].localeCompare(i[0])||t[1].localeCompare(i[1]))}loadState(e){this.overlaps.clear(),this.pendingPairs=e}syncWithWorld(e){let t=new Map;for(let i of e)t.set(i.label,i);for(let[i,o]of this.pendingPairs){let r=t.get(i),s=t.get(o);r&&s&&this.overlaps.set(this.makeKey(r,s),{trigger:r,other:s})}this.pendingPairs=[]}makeKey(e,t){return`${e.label}:${t.label}`}};function fo(n){return n.isTrigger=!0,n}var pr={x:0,y:g(-30),z:0},hr=g(.1),mr=g(.1),et=g(.12),fr=20,yr=10,gr=8;function yo(n=1/60){let e={bodies:[],gravity:Rt(pr),dt:g(n),triggers:new Je,step(){return zn(e)}};return e}function go(n,e){n.bodies.push(e)}function xo(n,e){let t=n.bodies.indexOf(e);t>=0&&(n.bodies.splice(t,1),n.triggers.removeBody(e))}function So(n,e,t=.15){let i=g(t);for(let o of n.bodies){if(o===e)continue;let r=Ne(e,o);if(r&&r.normal.y>32768)return!0;let s=e.position.y;e.position.y=e.position.y-i;let a=Ne(e,o);if(e.position.y=s,a&&a.normal.y>32768)return!0}return!1}function zn(n){let{gravity:e,dt:t,triggers:i}=n,o=[],r=[],s=[...n.bodies].sort((l,d)=>l.label.localeCompare(d.label)),a=new Set,c=new Set;for(let l=0;l<s.length;l++)for(let d=l+1;d<s.length;d++){let u=s[l],h=s[d];if(u.invMass===0&&h.invMass===0||!Ft(u.filter,h.filter))continue;let m=Ve(u),f=Ve(h);if(!bt(m,f))continue;let y=Ne(u,h);y&&F(y.normal.y)>32768&&(a.add(u),a.add(h),u.isSleeping&&h.type===2&&$(h.linearVelocity)+$(h.angularVelocity)<p(et,et)&&c.add(h),h.isSleeping&&u.type===2&&$(u.linearVelocity)+$(u.angularVelocity)<p(et,et)&&c.add(u))}for(let l of s){if(l.type!==2||l.isSleeping)continue;l.linearVelocity=N(l.linearVelocity,B(e,t));let d=65536-hr,u=65536-mr;a.has(l)&&(d=p(d,g(.95)),u=p(u,g(.9))),l.linearVelocity=B(l.linearVelocity,d),l.angularVelocity=B(l.angularVelocity,u)}for(let l=0;l<gr;l++)for(let d=0;d<s.length;d++)for(let u=d+1;u<s.length;u++){let h=s[d],m=s[u];if(h.invMass===0&&m.invMass===0||!Ft(h.filter,m.filter))continue;let f=Ve(h),y=Ve(m);if(!bt(f,y))continue;let x=Ne(h,m);x&&(h.isTrigger||m.isTrigger?l===0&&(h.isTrigger&&r.push({trigger:h,other:m}),m.isTrigger&&r.push({trigger:m,other:h})):(l===0&&o.push(x),vn(x)))}i.processOverlaps(r);for(let l of s){if(l.type===0||l.isSleeping)continue;let d=g(.05);if(F(l.linearVelocity.x)<d&&(l.linearVelocity.x=0),F(l.linearVelocity.y)<d&&(l.linearVelocity.y=0),F(l.linearVelocity.z)<d&&(l.linearVelocity.z=0),l.position=N(l.position,B(l.linearVelocity,t)),l.lockRotationX&&l.lockRotationY&&l.lockRotationZ)continue;let u=l.lockRotationX?0:l.angularVelocity.x,h=l.lockRotationY?0:l.angularVelocity.y,m=l.lockRotationZ?0:l.angularVelocity.z,f=g(.01);F(u)<f&&(u=0),F(h)<f&&(h=0),F(m)<f&&(m=0),l.angularVelocity.x=u,l.angularVelocity.y=h,l.angularVelocity.z=m;let y=p(u,u)+p(h,h)+p(m,m);if(y>0){let E=M(y),A=p(E,t),D=b(65536,E),R={x:p(u,D),y:p(h,D),z:p(m,D)},O=Pt(R,A);l.rotation=_t(Mt(O,l.rotation))}let x=$(l.linearVelocity),v=$(l.angularVelocity),C=p(et,et);if(x<C&&v<C){let E=c.has(l)?1+yr:1;l.sleepFrames+=E,l.sleepFrames>=fr&&(l.isSleeping=!0,l.linearVelocity=de(),l.angularVelocity=de())}else l.sleepFrames=0,l.isSleeping=!1}return o}function vo(n,e,t,i){let o=ue(t),r=null,s=i;for(let a of n.bodies){let c=xr(a,e,o,s);c&&c.distance<s&&(s=c.distance,r=c)}return r}function xr(n,e,t,i){return n.shape.type===1?Sr(n,e,t,i):vr(n,e,t,i)}function Sr(n,e,t,i){let o=n.shape,r=_(e,n.position),s=k(t,t),a=p(g(2),k(r,t)),c=k(r,r)-p(o.radius,o.radius),l=p(a,a)-p(p(g(4),s),c);if(l<0)return null;let d=M(l),u=b(-a-d,p(g(2),s));if(u<0&&(u=b(-a+d,p(g(2),s)),u<0)||u>i)return null;let h=N(e,B(t,u)),m=ue(_(h,n.position));return{body:n,point:h,normal:m,distance:u}}function vr(n,e,t,i){let r=n.shape.halfExtents,s=n.position,a=-2147483647,c=2147483647,l=0,d=1;{let m=t.x!==0?b(65536,t.x):2147483647,f=p(s.x-r.x-e.x,m),y=p(s.x+r.x-e.x,m);if(m<0&&([f,y]=[y,f]),f>a&&(a=f,l=0,d=m<0?1:-1),y<c&&(c=y),c<a)return null}{let m=t.y!==0?b(65536,t.y):2147483647,f=p(s.y-r.y-e.y,m),y=p(s.y+r.y-e.y,m);if(m<0&&([f,y]=[y,f]),f>a&&(a=f,l=1,d=m<0?1:-1),y<c&&(c=y),c<a)return null}{let m=t.z!==0?b(65536,t.z):2147483647,f=p(s.z-r.z-e.z,m),y=p(s.z+r.z-e.z,m);if(m<0&&([f,y]=[y,f]),f>a&&(a=f,l=2,d=m<0?1:-1),y<c&&(c=y),c<a)return null}if(a<0||a>i)return null;let u=N(e,B(t,a)),h=P(l===0?g(d):0,l===1?g(d):0,l===2?g(d):0);return{body:n,point:u,normal:h,distance:a}}function bo(n){return{bodies:n.bodies.map(e=>({id:e.id,label:e.label,px:e.position.x,py:e.position.y,pz:e.position.z,qx:e.rotation.x,qy:e.rotation.y,qz:e.rotation.z,qw:e.rotation.w,vx:e.linearVelocity.x,vy:e.linearVelocity.y,vz:e.linearVelocity.z,avx:e.angularVelocity.x,avy:e.angularVelocity.y,avz:e.angularVelocity.z,isSleeping:e.isSleeping,sleepFrames:e.sleepFrames}))}}function Fo(n,e){let t=new Set(e.bodies.map(o=>o.label));for(let o=n.bodies.length-1;o>=0;o--)t.has(n.bodies[o].label)||n.bodies.splice(o,1);let i=new Map(n.bodies.map(o=>[o.label,o]));for(let o of e.bodies){let r=i.get(o.label);r&&(r.position={x:o.px,y:o.py,z:o.pz},r.rotation={x:o.qx,y:o.qy,z:o.qz,w:o.qw},r.linearVelocity={x:o.vx,y:o.vy,z:o.vz},r.angularVelocity={x:o.avx,y:o.avy,z:o.avz},r.isSleeping=o.isSleeping,r.sleepFrames=o.sleepFrames)}}return Io(br);})();
